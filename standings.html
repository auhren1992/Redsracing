<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Standings - RedsRacing #8</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Racing+Sans+One&family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/scrollreveal"></script>
    <link rel="stylesheet" href="styles/main.css">
</head>
<body class="bg-dark-blue">
    <header class="bg-black/30 backdrop-blur-md sticky w-full top-0 z-50 border-b border-slate-700/50">
        <nav class="container mx-auto px-6 py-3 flex justify-between items-center">
            <a href="index.html" class="text-4xl font-racing uppercase tracking-wider">
                <span class="title-blue">Reds</span><span class="neon-yellow">Racing</span>
            </a>
            <div class="hidden md:flex items-center space-x-6 font-bold">
                <a href="index.html" class="hover:text-neon-yellow transition duration-300">Home</a>
                <div class="relative dropdown">
                    <button class="dropdown-toggle hover:text-neon-yellow transition duration-300 flex items-center">
                        The Drivers <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div class="dropdown-menu absolute hidden bg-slate-800 rounded-md shadow-lg mt-2 py-1 w-48 z-50">
                        <a href="driver.html" class="block px-4 py-2 text-sm text-slate-300 hover:bg-slate-700 hover:text-white">Jon Kirsch</a>
                        <a href="jonny.html" class="block px-4 py-2 text-sm text-slate-300 hover:bg-slate-700 hover:text-white">Jonny Kirsch #88</a>
                    </div>
                </div>
                <a href="schedule.html" class="hover:text-neon-yellow transition duration-300">Schedule</a>
                <div class="relative dropdown">
                    <button class="dropdown-toggle hover:text-neon-yellow transition duration-300 flex items-center">
                        Media <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div class="dropdown-menu absolute hidden bg-slate-800 rounded-md shadow-lg mt-2 py-1 w-48 z-50">
                        <a href="gallery.html" class="block px-4 py-2 text-sm text-slate-300 hover:bg-slate-700 hover:text-white">Gallery</a>
                        <a href="videos.html" class="block px-4 py-2 text-sm text-slate-300 hover:bg-slate-700 hover:text-white">Videos</a>
                    </div>
                </div>
                <div class="relative dropdown">
                    <button class="dropdown-toggle hover:text-neon-yellow transition duration-300 flex items-center">
                        Community <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div class="dropdown-menu absolute hidden bg-slate-800 rounded-md shadow-lg mt-2 py-1 w-48 z-50">
                        <a href="standings.html" class="block px-4 py-2 text-sm text-slate-300 hover:bg-slate-700 hover:text-white">Standings</a>
                        <a href="qna.html" class="block px-4 py-2 text-sm text-slate-300 hover:bg-slate-700 hover:text-white">Q&A</a>
                    </div>
                </div>
                <a id="auth-link" href="login.html" class="bg-neon-yellow text-slate-900 py-2 px-5 rounded-md hover:bg-yellow-300 transition duration-300">
                    DRIVER LOGIN
                </a>
            </div>
            <button id="mobile-menu-button" class="md:hidden text-white focus:outline-none">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
            </button>
        </nav>
        <div id="mobile-menu" class="hidden md:hidden bg-slate-900/90">
             <a href="index.html" class="block py-3 px-6 text-sm hover:bg-slate-800">Home</a>
             <button class="mobile-accordion text-sm px-6 pt-3 font-bold text-slate-400 w-full text-left">The Drivers</button>
             <div class="mobile-accordion-content hidden pl-4">
                 <a href="driver.html" class="block py-2 pl-6 text-sm hover:bg-slate-800">Jon Kirsch</a>
                 <a href="jonny.html" class="block py-2 pl-6 text-sm hover:bg-slate-800">Jonny Kirsch #88</a>
             </div>
             <a href="schedule.html" class="block py-3 px-6 text-sm hover:bg-slate-800">Schedule</a>
             <button class="mobile-accordion text-sm px-6 pt-3 font-bold text-slate-400 w-full text-left">Media</button>
             <div class="mobile-accordion-content hidden pl-4">
                 <a href="gallery.html" class="block py-2 pl-6 text-sm hover:bg-slate-800">Gallery</a>
                 <a href="videos.html" class="block py-2 pl-6 text-sm hover:bg-slate-800">Videos</a>
             </div>
             <button class="mobile-accordion text-sm px-6 pt-3 font-bold text-slate-400 w-full text-left">Community</button>
             <div class="mobile-accordion-content hidden pl-4">
                 <a href="standings.html" class="block py-2 pl-6 text-sm hover:bg-slate-800">Standings</a>
                 <a href="qna.html" class="block py-2 pl-6 text-sm hover:bg-slate-800">Q&A</a>
             </div>
             <a id="auth-link-mobile" href="login.html" class="block py-3 px-6 text-sm hover:bg-slate-800">DRIVER LOGIN</a>
        </div>
    </header>
    <main class="pt-20">
        <section id="standings" class="py-24 md:py-32 section-glow">
            <div class="container mx-auto px-6">
                <h2 class="font-racing text-5xl uppercase mb-12 text-center reveal-fade">Championship <span class="neon-yellow">Standings</span></h2>
                <div class="max-w-4xl mx-auto bg-slate-900/50 p-8 rounded-lg reveal-up">
                    <div id="standings-table-container">
                        <p class="text-slate-400 text-center">Loading standings...</p>
                    </div>
                </div>
            </div>
        </section>
    </main>
    <footer class="bg-black/50 border-t border-slate-800 py-16">
        <!-- Footer content from other pages -->
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', () => {
            // Standard nav and auth logic
            document.querySelectorAll('.dropdown-toggle').forEach(button => {
                button.addEventListener('click', (event) => {
                    event.stopPropagation();
                    const dropdownMenu = button.nextElementSibling;
                    const isHidden = dropdownMenu.classList.contains('hidden');
                    document.querySelectorAll('.dropdown-menu').forEach(menu => menu.classList.add('hidden'));
                    if (isHidden) dropdownMenu.classList.remove('hidden');
                });
            });
            window.addEventListener('click', () => document.querySelectorAll('.dropdown-menu').forEach(menu => menu.classList.add('hidden')));
            document.getElementById('mobile-menu-button').addEventListener('click', () => document.getElementById('mobile-menu').classList.toggle('hidden'));

            const firebaseConfig = {
              apiKey: "AIzaSyARFiFCadGKFUc_s6x3qNX8F4jsVawkzVg",
              authDomain: "redsracing-a7f8b.firebaseapp.com",
              projectId: "redsracing-a7f8b",
              storageBucket: "redsracing-a7f8b.firebasestorage.app",
              messagingSenderId: "517034606151",
              appId: "1:517034606151:web:24cae262e1d98832757b62"
            };
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);
            onAuthStateChanged(auth, user => {
                const authLink = document.getElementById('auth-link');
                if (user) {
                    authLink.textContent = 'Dashboard';
                    authLink.href = 'dashboard.html';
                } else {
                    authLink.textContent = 'DRIVER LOGIN';
                    authLink.href = 'login.html';
                }
            });

            const standingsContainer = document.getElementById('standings-table-container');

            const fetchAndCalculateStandings = async () => {
                try {
                    const standings = new Map();
                    const racesQuery = query(collection(db, "races"), where("isComplete", "==", true));
                    const racesSnapshot = await getDocs(racesQuery);

                    for (const raceDoc of racesSnapshot.docs) {
                        const resultsSnapshot = await getDocs(collection(db, `races/${raceDoc.id}/results`));
                        resultsSnapshot.forEach(resultDoc => {
                            const result = resultDoc.data();
                            const driverId = resultDoc.id;
                            if (standings.has(driverId)) {
                                standings.get(driverId).points += result.pointsEarned;
                                standings.get(driverId).races += 1;
                            } else {
                                standings.set(driverId, {
                                    name: result.driverName,
                                    points: result.pointsEarned,
                                    races: 1,
                                });
                            }
                        });
                    }

                    if (standings.size === 0) {
                        standingsContainer.innerHTML = '<p class="text-slate-400 text-center">No results have been posted yet. Standings will appear here once the first race is complete.</p>';
                        return;
                    }

                    const sortedStandings = Array.from(standings.values()).sort((a, b) => b.points - a.points);

                    let tableHTML = `
                        <table class="w-full text-left">
                            <thead>
                                <tr class="border-b-2 border-neon-yellow">
                                    <th class="p-4">Pos</th>
                                    <th class="p-4">Driver</th>
                                    <th class="p-4 text-right">Races</th>
                                    <th class="p-4 text-right">Points</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${sortedStandings.map((driver, index) => `
                                    <tr class="border-b border-slate-700">
                                        <td class="p-4 font-bold text-lg">${index + 1}</td>
                                        <td class="p-4 font-bold text-lg text-white">${driver.name}</td>
                                        <td class="p-4 text-right">${driver.races}</td>
                                        <td class="p-4 font-bold text-lg text-neon-yellow text-right">${driver.points}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                    standingsContainer.innerHTML = tableHTML;

                } catch (error) {
                    console.error("Error calculating standings:", error);
                    standingsContainer.innerHTML = '<p class="text-red-400 text-center">Could not load standings due to an error.</p>';
                }
            };

            fetchAndCalculateStandings();
        });
    </script>
</body>
</html>
