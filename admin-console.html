<!doctype html>
<html lang="en" class="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>üèéÔ∏è Admin Command Center - RedsRacing #8</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico" />
    <link rel="icon" type="image/svg+xml" href="favicon.svg" />
    <link rel="apple-touch-icon" href="apple-touch-icon.png" />
    <link rel="manifest" href="site.webmanifest" />
    <link rel="stylesheet" href="styles/tailwind.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Racing+Sans+One&family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styles/main.css" />
    <meta name="sentry-dsn" content="https://962693d042f18049bc26bee0c31c54fd@o4510070455992320.ingest.us.sentry.io/4510088885239808" />
    
    <style>
      /* Modern Admin Console Styles */
      .admin-glass {
        background: rgba(15, 23, 42, 0.4);
        backdrop-filter: blur(16px);
        border: 1px solid rgba(148, 163, 184, 0.1);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      }
      
      .admin-card {
        background: linear-gradient(145deg, rgba(30, 41, 59, 0.6), rgba(15, 23, 42, 0.8));
        backdrop-filter: blur(12px);
        border: 1px solid rgba(148, 163, 184, 0.1);
        box-shadow: 0 4px 24px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
      }
      
      .admin-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 40px rgba(0, 0, 0, 0.3);
        border-color: rgba(251, 191, 36, 0.3);
      }
      
      .stat-card {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(147, 51, 234, 0.1));
        backdrop-filter: blur(8px);
        border: 1px solid rgba(59, 130, 246, 0.2);
        transition: all 0.3s ease;
      }
      
      .stat-card:hover {
        transform: scale(1.02);
        border-color: rgba(251, 191, 36, 0.4);
      }
      
      .modern-btn {
        background: linear-gradient(45deg, #3b82f6, #6366f1);
        border: none;
        box-shadow: 0 4px 16px rgba(59, 130, 246, 0.3);
        transition: all 0.3s ease;
      }
      
      .modern-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 8px 24px rgba(59, 130, 246, 0.4);
      }
      
      .success-btn {
        background: linear-gradient(45deg, #10b981, #059669);
        box-shadow: 0 4px 16px rgba(16, 185, 129, 0.3);
      }
      
      .danger-btn {
        background: linear-gradient(45deg, #ef4444, #dc2626);
        box-shadow: 0 4px 16px rgba(239, 68, 68, 0.3);
      }
      
      .sidebar-nav {
        background: rgba(15, 23, 42, 0.6);
        backdrop-filter: blur(16px);
        border-right: 1px solid rgba(148, 163, 184, 0.1);
      }
      
      .nav-item {
        position: relative;
        transition: all 0.3s ease;
        border-radius: 8px;
        margin: 4px 0;
      }
      
      .nav-item:hover {
        background: rgba(59, 130, 246, 0.1);
        transform: translateX(4px);
      }
      
      .nav-item.active {
        background: linear-gradient(45deg, rgba(251, 191, 36, 0.2), rgba(245, 158, 11, 0.1));
        border-left: 3px solid #fbbf24;
      }
      
      .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1.5rem;
      }
      
      .countdown-digit {
        background: linear-gradient(145deg, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.9));
        border: 1px solid rgba(251, 191, 36, 0.3);
        border-radius: 12px;
        box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.3);
      }
      
      .animated-counter {
        animation: countUp 0.5s ease-out;
      }
      
      @keyframes countUp {
        from { opacity: 0; transform: scale(0.5); }
        to { opacity: 1; transform: scale(1); }
      }
      
      .pulse-glow {
        animation: pulseGlow 2s ease-in-out infinite alternate;
      }
      
      @keyframes pulseGlow {
        from { box-shadow: 0 0 20px rgba(251, 191, 36, 0.3); }
        to { box-shadow: 0 0 40px rgba(251, 191, 36, 0.6); }
      }
      
      .typing-indicator {
        display: inline-block;
        animation: typing 1.5s infinite;
      }
      
      @keyframes typing {
        0%, 50% { opacity: 1; }
        51%, 100% { opacity: 0.3; }
      }
      
      .modern-table {
        background: rgba(15, 23, 42, 0.6);
        backdrop-filter: blur(8px);
        border-radius: 12px;
        overflow: hidden;
        border: 1px solid rgba(148, 163, 184, 0.1);
      }
      
      .table-header {
        background: linear-gradient(90deg, rgba(59, 130, 246, 0.1), rgba(147, 51, 234, 0.1));
        border-bottom: 1px solid rgba(148, 163, 184, 0.2);
      }
      
      .table-row {
        border-bottom: 1px solid rgba(148, 163, 184, 0.05);
        transition: all 0.3s ease;
      }
      
      .table-row:hover {
        background: rgba(59, 130, 246, 0.05);
      }
      
      .status-badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }
      
      .status-approved {
        background: rgba(16, 185, 129, 0.2);
        color: #10b981;
        border: 1px solid rgba(16, 185, 129, 0.3);
      }
      
      .status-pending {
        background: rgba(245, 158, 11, 0.2);
        color: #f59e0b;
        border: 1px solid rgba(245, 158, 11, 0.3);
      }
      
      .status-rejected {
        background: rgba(239, 68, 68, 0.2);
        color: #ef4444;
        border: 1px solid rgba(239, 68, 68, 0.3);
      }
      
      .modern-input {
        background: rgba(15, 23, 42, 0.6);
        border: 1px solid rgba(148, 163, 184, 0.2);
        border-radius: 8px;
        transition: all 0.3s ease;
      }
      
      .modern-input:focus {
        border-color: rgba(59, 130, 246, 0.5);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }
      
      .loading-shimmer {
        background: linear-gradient(90deg, rgba(148, 163, 184, 0.1) 25%, rgba(148, 163, 184, 0.2) 50%, rgba(148, 163, 184, 0.1) 75%);
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
      }
      
      @keyframes shimmer {
        0% { background-position: -200% 0; }
        100% { background-position: 200% 0; }
      }
      
      .chart-container {
        position: relative;
        height: 200px;
        background: rgba(15, 23, 42, 0.4);
        border-radius: 12px;
        border: 1px solid rgba(148, 163, 184, 0.1);
      }
    </style>
  <script src="assets/js/guest-gate.js"></script>
  </head>
  <body class="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900">
    <!-- Clean Modern Header -->
    <header class="bg-black/30 backdrop-blur-md sticky w-full top-0 z-50 border-b border-slate-700/50">
      <nav class="container mx-auto px-6 py-3 flex justify-between items-center">
        <a href="index.html" class="text-4xl font-racing uppercase tracking-wider">
          <span class="title-blue">Reds</span><span class="neon-yellow">Racing</span>
        </a>
        
        <!-- Navigation Links -->
        <div class="hidden md:flex items-center space-x-6 font-bold">
          <a href="index.html" class="nav-link">üè† Home</a>
          <div class="relative dropdown">
            <button class="dropdown-toggle nav-link">
              üèéÔ∏è Drivers <i class="fas fa-chevron-down"></i>
            </button>
            <div class="dropdown-menu modern-dropdown">
              <a href="driver.html" class="dropdown-item">Jon Kirsch #8</a>
              <a href="jonny.html" class="dropdown-item">Jonny Kirsch #88</a>
              <a href="legends.html" class="dropdown-item">Team Legends</a>
            </div>
          </div>
          <div class="relative dropdown">
            <button class="dropdown-toggle nav-link">
              üèÅ Racing <i class="fas fa-chevron-down"></i>
            </button>
            <div class="dropdown-menu modern-dropdown">
              <a href="schedule.html" class="dropdown-item">Schedule</a>
              <a href="leaderboard.html" class="dropdown-item">Leaderboard</a>
              <a href="gallery.html" class="dropdown-item">üì∏ Gallery</a>
            </div>
          </div>
          <div class="relative dropdown">
            <button class="dropdown-toggle nav-link">
              üë• Community <i class="fas fa-chevron-down"></i>
            </button>
            <div class="dropdown-menu modern-dropdown">
              <a href="feedback.html" class="dropdown-item">Feedback</a>
              <a href="sponsorship.html" class="dropdown-item">Sponsorship</a>
            </div>
          </div>
          
        </div>
        
        <!-- Mobile Menu Button -->
        <button id="mobile-menu-button" class="md:hidden text-white focus:outline-none">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path>
          </svg>
        </button>
        <!-- Admin top auth pill -->
        <div id="admin-top-auth" class="hidden md:flex items-center space-x-3 ml-4">
          <div id="admin-online-dot" class="w-2 h-2 bg-green-400 rounded-full animate-pulse" style="display:none"></div>
          <span id="admin-user-email" class="text-slate-300 text-sm"></span>
<button id="logout-button-top" class="bg-slate-800/50 hover:bg-slate-700/50 border border-slate-600/50 text-white px-3 py-1 rounded text-sm flex items-center"><i class="fas fa-sign-out-alt mr-2"></i>Sign Out</button>
        </div>
      </nav>
      
      <!-- Mobile Menu -->
      <div id="mobile-menu" class="mobile-menu modern-mobile hidden">
        <div class="p-4 border-b border-slate-600">
          <div class="flex items-center space-x-3">
            <div class="w-10 h-10 bg-gradient-to-br from-yellow-400 to-red-500 rounded-lg flex items-center justify-center">
              <i class="fas fa-crown text-white text-lg"></i>
            </div>
            <div>
              <h4 class="text-white font-bold">Admin Console</h4>
              <p class="text-slate-400 text-sm">Command Center</p>
            </div>
          </div>
        </div>
        
        <div class="p-4 space-y-2">
          <a href="index.html" class="mobile-nav-item flex items-center p-3 rounded-lg hover:bg-slate-700/50 transition-colors">
            <i class="fas fa-home w-5 mr-3 text-blue-400"></i>
            <span>Back to Site</span>
          </a>
          
          <div class="border-t border-slate-600 my-3"></div>
          
          <button class="mobile-accordion w-full text-left p-3 rounded-lg hover:bg-slate-700/50 transition-colors flex items-center justify-between">
            <div class="flex items-center">
              <i class="fas fa-tachometer-alt w-5 mr-3 text-green-400"></i>
              <span>Dashboard</span>
            </div>
            <i class="fas fa-chevron-down accordion-icon"></i>
          </button>
          <div class="mobile-accordion-content pl-8 space-y-1">
            <a href="#overview" class="mobile-nav-subitem block p-2 rounded text-sm hover:bg-slate-700/30">Overview</a>
            <a href="#races" class="mobile-nav-subitem block p-2 rounded text-sm hover:bg-slate-700/30">Race Management</a>
          </div>
          
          <button class="mobile-accordion w-full text-left p-3 rounded-lg hover:bg-slate-700/50 transition-colors flex items-center justify-between">
            <div class="flex items-center">
              <i class="fas fa-photo-video w-5 mr-3 text-purple-400"></i>
              <span>Media</span>
            </div>
            <i class="fas fa-chevron-down accordion-icon"></i>
          </button>
          <div class="mobile-accordion-content pl-8 space-y-1">
            <a href="#media" class="mobile-nav-subitem block p-2 rounded text-sm hover:bg-slate-700/30">
              Media Approvals
              <span class="ml-2 bg-red-500 text-white text-xs px-2 py-0.5 rounded-full">0</span>
            </a>
            <a href="gallery.html" class="mobile-nav-subitem block p-2 rounded text-sm hover:bg-slate-700/30">View Gallery</a>
          </div>
          
          <a href="#advanced" class="mobile-nav-item flex items-center p-3 rounded-lg hover:bg-slate-700/50 transition-colors">
            <i class="fas fa-users-cog w-5 mr-3 text-yellow-300"></i>
            <span>Team & Roles</span>
          </a>
          
          <a href="settings.html" class="mobile-nav-item flex items-center p-3 rounded-lg hover:bg-slate-700/50 transition-colors">
            <i class="fas fa-cog w-5 mr-3 text-slate-400"></i>
            <span>Settings</span>
          </a>
        </div>
        
        <div class="border-t border-slate-600 mt-4 p-4">
          <button id="mobile-logout-button" class="w-full bg-red-600 hover:bg-red-700 text-white p-3 rounded-lg font-semibold transition-colors flex items-center justify-center">
            <i class="fas fa-sign-out-alt mr-2"></i>Sign Out
          </button>
        </div>
      </div>
    </header>

    <!-- Main Dashboard Layout -->
    <div class="flex min-h-screen">
      <!-- Modern Sidebar -->
      <aside class="sidebar-nav w-64 lg:w-72 flex-shrink-0 hidden lg:block">
        <div class="p-6">
          <div class="mb-8">
            <h2 class="text-lg font-bold text-white mb-2">
              <i class="fas fa-crown text-yellow-400 mr-2"></i>
              Admin Dashboard
            </h2>
            <p class="text-xs text-slate-400">Racing Team Management</p>
          </div>
          
          <nav class="space-y-1">
            <a href="#overview" class="nav-item active flex items-center px-3 py-2 text-sm font-medium text-white">
              <i class="fas fa-chart-pie w-5 mr-3 text-blue-400"></i>
              <span>Overview</span>
              <div class="ml-auto w-2 h-2 bg-yellow-400 rounded-full"></div>
            </a>
            <a href="#race" class="nav-item flex items-center px-3 py-2 text-sm font-medium text-slate-300">
              <i class="fas fa-flag-checkered w-5 mr-3 text-green-400"></i>
              <span>Race Management</span>
            </a>
            <a href="#media" class="nav-item flex items-center px-3 py-2 text-sm font-medium text-slate-300">
              <i class="fas fa-photo-video w-5 mr-3 text-purple-400"></i>
              <span>Media</span>
              <span class="ml-auto bg-red-500 text-white text-xs px-2 py-0.5 rounded-full" id="gallery-pending-count">0</span>
            </a>
            <a href="#qna" class="nav-item flex items-center px-3 py-2 text-sm font-medium text-slate-300">
              <i class="fas fa-question-circle w-5 mr-3 text-cyan-400"></i>
              <span>Q&A Management</span>
            </a>
            <a href="#logs" class="nav-item flex items-center px-3 py-2 text-sm font-medium text-slate-300">
              <i class="fas fa-bug w-5 mr-3 text-red-400"></i>
              <span>Error Logs</span>
            </a>
            
            <div class="border-t border-white/10 my-4"></div>
            <h3 class="text-xs uppercase tracking-wider text-slate-400 px-3 mt-3">Admin Only</h3>
            <a href="#admin-pages" class="nav-item flex items-center px-3 py-2 text-sm font-medium text-slate-300">
              <i class="fas fa-file-pen w-5 mr-3 text-yellow-300"></i>
              <span>Page Management</span>
            </a>
            
            <a href="#analytics" class="nav-item flex items-center px-3 py-2 text-sm font-medium text-slate-300">
              <i class="fas fa-chart-line w-5 mr-3 text-emerald-400"></i>
              <span>Analytics</span>
            </a>
            <a href="#advanced" class="nav-item flex items-center px-3 py-2 text-sm font-medium text-slate-300">
              <i class="fas fa-users-cog w-5 mr-3 text-yellow-300"></i>
              <span>Team & Roles</span>
            </a>
          <a href="settings.html" class="nav-item flex items-center px-3 py-2 text-sm font-medium text-slate-300">
              <i class="fas fa-cog w-5 mr-3 text-slate-400"></i>
              <span>Settings</span>
            </a>
          </nav>
        </div>
      </aside>
      
      <!-- Main Content -->
      <main class="flex-1 overflow-hidden">
        <!-- Mobile Sidebar Toggle -->
        <div class="lg:hidden p-4 border-b border-white/10">
          <button id="sidebar-toggle" class="admin-card px-4 py-2 rounded-lg w-full text-left flex items-center">
            <i class="fas fa-bars text-yellow-400 mr-2"></i>
            <span class="font-racing uppercase text-sm text-white">Admin Menu</span>
          </button>
        </div>

        <!-- Dashboard Content -->
        <div class="p-4 lg:p-6 space-y-6">
          <!-- Error Container -->
          <div id="auth-error-container" class="mb-4"></div>
          
          <!-- Modern Loading State -->
          <div id="loading-state" class="flex flex-col items-center justify-center min-h-[60vh]">
            <div class="relative">
              <!-- Animated Logo -->
              <div class="w-20 h-20 border-4 border-blue-500/20 border-t-blue-500 rounded-full animate-spin"></div>
              <div class="absolute inset-0 w-16 h-16 m-auto border-4 border-yellow-400/20 border-b-yellow-400 rounded-full animate-spin" style="animation-direction: reverse; animation-duration: 0.8s;"></div>
            </div>
            <div class="mt-6 text-center">
              <h3 class="text-xl font-bold text-white mb-2">
                <i class="fas fa-rocket text-blue-400 mr-2"></i>
                Initializing Command Center
              </h3>
              <p class="text-slate-400 text-sm">
                Loading racing data and system status
                <span class="typing-indicator">...</span>
              </p>
              <div class="mt-4 flex justify-center">
                <div class="flex space-x-1">
                  <div class="w-2 h-2 bg-blue-400 rounded-full animate-bounce"></div>
                  <div class="w-2 h-2 bg-yellow-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                  <div class="w-2 h-2 bg-green-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Modern Dashboard Content (Overview) -->
          <div id="dashboard-content" class="hidden space-y-6">
            <!-- Welcome Header -->
            <div class="admin-card rounded-xl p-6">
              <div class="flex items-center justify-between mb-4">
                <div>
                  <h1 class="text-2xl font-bold text-white mb-1">
                    Welcome back, Admin üèÅ
                  </h1>
                  <p class="text-slate-400 text-sm">Your racing empire awaits your command</p>
                </div>
                <div class="text-right">
                  <div class="text-sm text-slate-400">Last login</div>
                  <div class="text-white font-semibold" id="last-login-time">Just now</div>
                </div>
              </div>
            </div>
            
            <!-- Statistics Grid -->
            <div class="dashboard-grid">
              <!-- Total Races Stat -->
              <div class="stat-card rounded-xl p-6">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-slate-400 text-sm font-medium mb-1">Total Races</p>
                    <div class="flex items-center space-x-2">
                      <span class="text-3xl font-bold text-white animated-counter" id="total-races">12</span>
                      <div class="text-green-400 text-sm flex items-center">
                        <i class="fas fa-arrow-up mr-1"></i>+2
                      </div>
                    </div>
                  </div>
                  <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-emerald-600 rounded-lg flex items-center justify-center">
                    <i class="fas fa-flag-checkered text-white text-xl"></i>
                  </div>
                </div>
              </div>
              
              <!-- Pending Approvals Stat -->
              <div class="stat-card rounded-xl p-6">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-slate-400 text-sm font-medium mb-1">Pending Approvals</p>
                    <div class="flex items-center space-x-2">
                      <span class="text-3xl font-bold text-white animated-counter" id="pending-approvals">0</span>
                      <div class="text-orange-400 text-sm">
                        <i class="fas fa-clock mr-1"></i>Needs attention
                      </div>
                    </div>
                  </div>
                  <div class="w-12 h-12 bg-gradient-to-br from-orange-500 to-amber-600 rounded-lg flex items-center justify-center pulse-glow">
                    <i class="fas fa-exclamation text-white text-xl"></i>
                  </div>
                </div>
              </div>
              
              <!-- Gallery Photos Stat -->
              <div class="stat-card rounded-xl p-6">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-slate-400 text-sm font-medium mb-1">Gallery Photos</p>
                    <div class="flex items-center space-x-2">
                      <span class="text-3xl font-bold text-white animated-counter" id="total-photos">0</span>
                      <div class="text-blue-400 text-sm flex items-center">
                        <i class="fas fa-camera mr-1"></i>Live
                      </div>
                    </div>
                  </div>
                  <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-cyan-600 rounded-lg flex items-center justify-center">
                    <i class="fas fa-images text-white text-xl"></i>
                  </div>
                </div>
              </div>
              
              <!-- Active Users Stat -->
              <div class="stat-card rounded-xl p-6">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-slate-400 text-sm font-medium mb-1">Active Users</p>
                    <div class="flex items-center space-x-2">
                      <span class="text-3xl font-bold text-white animated-counter" id="active-users">1,234</span>
                      <div class="text-purple-400 text-sm flex items-center">
                        <i class="fas fa-users mr-1"></i>Online
                      </div>
                    </div>
                  </div>
                  <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-pink-600 rounded-lg flex items-center justify-center">
                    <i class="fas fa-users text-white text-xl"></i>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Next Race & Notes Row -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <!-- Next Race Countdown -->
              <div class="admin-card rounded-xl p-6">
                <div class="flex items-center justify-between mb-6">
                  <h2 class="text-xl font-bold text-white">
                    <i class="fas fa-stopwatch text-red-400 mr-2"></i>
                    Next Race
                  </h2>
                  <span class="status-badge status-pending" id="race-status">Upcoming</span>
                </div>
                
                <div class="text-center mb-6">
                  <p id="next-race-name" class="text-2xl font-bold text-yellow-400 mb-2">Loading...</p>
                  <p class="text-slate-400 text-sm">Championship Round</p>
                </div>
                
                <div id="countdown-timer" class="grid grid-cols-4 gap-3">
                  <div class="countdown-digit p-3 text-center">
                    <div id="days" class="text-2xl font-bold text-white animated-counter">0</div>
                    <div class="text-xs uppercase text-slate-400 mt-1">Days</div>
                  </div>
                  <div class="countdown-digit p-3 text-center">
                    <div id="hours" class="text-2xl font-bold text-white animated-counter">0</div>
                    <div class="text-xs uppercase text-slate-400 mt-1">Hours</div>
                  </div>
                  <div class="countdown-digit p-3 text-center">
                    <div id="minutes" class="text-2xl font-bold text-white animated-counter">0</div>
                    <div class="text-xs uppercase text-slate-400 mt-1">Min</div>
                  </div>
                  <div class="countdown-digit p-3 text-center">
                    <div id="seconds" class="text-2xl font-bold text-yellow-400 animated-counter">0</div>
                    <div class="text-xs uppercase text-slate-400 mt-1">Sec</div>
                  </div>
                </div>
              </div>
              
            </div>
          </div>

            <div id="gallery-approvals" class="space-y-6">
              <div class="flex items-center justify-between">
                <h2 class="text-2xl font-bold text-white">
                  <i class="fas fa-images text-purple-400 mr-2"></i>
                  Gallery Approvals
                </h2>
                <div class="flex items-center space-x-2">
                  <span class="status-badge status-pending">3 Pending</span>
                </div>
              </div>
              
              <div id="photo-approval-card" class="admin-card rounded-xl p-6" style="display: none">
                <div class="mb-4">
                  <h3 class="text-lg font-semibold text-white mb-2">
                    <i class="fas fa-clock text-yellow-400 mr-2"></i>
                    Pending Photo Reviews
                  </h3>
                  <p class="text-sm text-slate-400">Review and approve photos before they appear in the public gallery</p>
                </div>
                <div id="unapproved-photos-list" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6"></div>
              </div>
            </div>
            
            <!-- Settings Section -->
            <div id="settings-section" class="space-y-6" style="display: none">
              <div class="flex items-center justify-between">
                <h2 class="text-3xl font-bold text-white">
                  <i class="fas fa-cogs text-yellow-400 mr-3"></i>
                  Website Settings
                </h2>
                <div class="flex items-center space-x-2">
                  <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                  <span class="text-green-400 text-sm font-medium">Live Editing</span>
                </div>
              </div>
              
              <!-- Team Roster Settings -->
              <div class="admin-card rounded-xl p-6">
                <h3 class="text-xl font-bold text-white mb-4">
                  <i class="fas fa-users text-blue-400 mr-2"></i>
                  Team Roster Management
                </h3>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                  <!-- Jon Kirsch Settings -->
                  <div class="space-y-4">
                    <h4 class="text-lg font-semibold text-white border-b border-slate-600 pb-2">
                      <i class="fas fa-trophy text-yellow-400 mr-2"></i>Jon Kirsch #8
                    </h4>
                    
                    <div class="grid grid-cols-2 gap-4">
                      <div>
                        <label class="block text-sm font-medium text-slate-300 mb-1">Racing Number</label>
                        <input type="text" id="jon-number" value="8" class="modern-input w-full p-3 text-white" />
                      </div>
                      <div>
                        <label class="block text-sm font-medium text-slate-300 mb-1">Years Racing</label>
                        <input type="number" id="jon-years" value="2" class="modern-input w-full p-3 text-white" />
                      </div>
                      <div>
                        <label class="block text-sm font-medium text-slate-300 mb-1">Wins</label>
                        <input type="number" id="jon-wins" value="12" class="modern-input w-full p-3 text-white" />
                      </div>
                      <div>
                        <label class="block text-sm font-medium text-slate-300 mb-1">Podium Finishes</label>
                        <input type="number" id="jon-podiums" value="11" class="modern-input w-full p-3 text-white" />
                      </div>
                    </div>
                    
                    <div>
                      <label class="block text-sm font-medium text-slate-300 mb-1">Driver Bio</label>
                      <textarea id="jon-bio" rows="3" class="modern-input w-full p-3 text-white resize-none" placeholder="Father ‚Ä¢ Mentor ‚Ä¢ Racing Legacy"></textarea>
                    </div>
                  </div>
                  
                  <!-- Jonny Kirsch Settings -->
                  <div class="space-y-4">
                    <h4 class="text-lg font-semibold text-white border-b border-slate-600 pb-2">
                      <i class="fas fa-bolt text-red-400 mr-2"></i>Jonny Kirsch #88
                    </h4>
                    
                    <div class="grid grid-cols-2 gap-4">
                      <div>
                        <label class="block text-sm font-medium text-slate-300 mb-1">Racing Number</label>
                        <input type="text" id="jonny-number" value="88" class="modern-input w-full p-3 text-white" />
                      </div>
                      <div>
                        <label class="block text-sm font-medium text-slate-300 mb-1">Years Racing</label>
                        <input type="number" id="jonny-years" value="1" class="modern-input w-full p-3 text-white" />
                      </div>
                      <div>
                        <label class="block text-sm font-medium text-slate-300 mb-1">Wins</label>
                        <input type="number" id="jonny-wins" value="8" class="modern-input w-full p-3 text-white" />
                      </div>
                      <div>
                        <label class="block text-sm font-medium text-slate-300 mb-1">Championships</label>
                        <input type="number" id="jonny-championships" value="1" class="modern-input w-full p-3 text-white" />
                      </div>
                    </div>
                    
                    <div>
                      <label class="block text-sm font-medium text-slate-300 mb-1">Driver Bio</label>
                      <textarea id="jonny-bio" rows="3" class="modern-input w-full p-3 text-white resize-none" placeholder="Next Generation ‚Ä¢ Speed Demon ‚Ä¢ Rising Star"></textarea>
                    </div>
                  </div>
                </div>
                
                <div class="mt-6 flex justify-end">
                  <button id="save-roster-btn" class="success-btn px-6 py-3 rounded-lg font-semibold flex items-center">
                    <i class="fas fa-save mr-2"></i>Save Team Changes
                  </button>
                </div>
              </div>
              
              <!-- Website Statistics Settings -->
              <div class="admin-card rounded-xl p-6">
                <h3 class="text-xl font-bold text-white mb-4">
                  <i class="fas fa-chart-bar text-green-400 mr-2"></i>
                  Website Statistics
                </h3>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                  <div class="space-y-4">
                    <h4 class="font-semibold text-white border-b border-slate-600 pb-2">Homepage Stats</h4>
                    <div class="grid grid-cols-2 gap-3">
                      <div>
                        <label class="block text-xs font-medium text-slate-400 mb-1">Years Racing</label>
                        <input type="number" id="homepage-years" value="2" class="modern-input w-full p-2 text-white text-sm" />
                      </div>
                      <div>
                        <label class="block text-xs font-medium text-slate-400 mb-1">Races Won</label>
                        <input type="number" id="homepage-wins" value="12" class="modern-input w-full p-2 text-white text-sm" />
                      </div>
                      <div>
                        <label class="block text-xs font-medium text-slate-400 mb-1">Racing Numbers</label>
                        <input type="text" id="homepage-numbers" value="#8 & #88" class="modern-input w-full p-2 text-white text-sm" />
                      </div>
                      <div>
                        <label class="block text-xs font-medium text-slate-400 mb-1">Active Users</label>
                        <input type="number" id="homepage-users" value="1234" class="modern-input w-full p-2 text-white text-sm" />
                      </div>
                    </div>
                  </div>
                  
                  <div class="space-y-4">
                    <h4 class="font-semibold text-white border-b border-slate-600 pb-2">Gallery Stats</h4>
                    <div class="space-y-3">
                      <div>
                        <label class="block text-xs font-medium text-slate-400 mb-1">Action Shots Count</label>
                        <input type="number" id="gallery-action" value="127" class="modern-input w-full p-2 text-white text-sm" />
                      </div>
                      <div>
                        <label class="block text-xs font-medium text-slate-400 mb-1">Victory Moments</label>
                        <input type="number" id="gallery-victory" value="45" class="modern-input w-full p-2 text-white text-sm" />
                      </div>
                      <div>
                        <label class="block text-xs font-medium text-slate-400 mb-1">Pit Crew Photos</label>
                        <input type="number" id="gallery-pit" value="89" class="modern-input w-full p-2 text-white text-sm" />
                      </div>
                      <div>
                        <label class="block text-xs font-medium text-slate-400 mb-1">Championships</label>
                        <input type="number" id="gallery-championships" value="23" class="modern-input w-full p-2 text-white text-sm" />
                      </div>
                    </div>
                  </div>
                  
                  <div class="space-y-4">
                    <h4 class="font-semibold text-white border-b border-slate-600 pb-2">Team Roster Stats</h4>
                    <div class="space-y-3">
                      <div>
                        <label class="block text-xs font-medium text-slate-400 mb-1">Active Drivers</label>
                        <input type="number" id="roster-drivers" value="2" class="modern-input w-full p-2 text-white text-sm" />
                      </div>
                      <div>
                        <label class="block text-xs font-medium text-slate-400 mb-1">Combined Experience</label>
                        <input type="text" id="roster-experience" value="2 Years" class="modern-input w-full p-2 text-white text-sm" />
                      </div>
                      <div>
                        <label class="block text-xs font-medium text-slate-400 mb-1">Team Legacy</label>
                        <input type="text" id="roster-legacy" value="#8" class="modern-input w-full p-2 text-white text-sm" />
                      </div>
                      <div>
                        <label class="block text-xs font-medium text-slate-400 mb-1">Racing Spirit</label>
                        <input type="text" id="roster-spirit" value="Unlimited" class="modern-input w-full p-2 text-white text-sm" />
                      </div>
                    </div>
                  </div>
                </div>
                
                <div class="mt-6 flex justify-end">
                  <button id="save-stats-btn" class="success-btn px-6 py-3 rounded-lg font-semibold flex items-center">
                    <i class="fas fa-chart-line mr-2"></i>Update Statistics
                  </button>
                </div>
              </div>
              
              <!-- Content Management -->
              <div class="admin-card rounded-xl p-6">
                <h3 class="text-xl font-bold text-white mb-4">
                  <i class="fas fa-edit text-purple-400 mr-2"></i>
                  Content Management
                </h3>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                  <div class="space-y-4">
                    <h4 class="font-semibold text-white border-b border-slate-600 pb-2">Homepage Content</h4>
                    <div>
                      <label class="block text-sm font-medium text-slate-300 mb-1">Hero Title</label>
                      <input type="text" id="hero-title" value="Push The Limit" class="modern-input w-full p-3 text-white" />
                    </div>
                    <div>
                      <label class="block text-sm font-medium text-slate-300 mb-1">Hero Subtitle</label>
                      <input type="text" id="hero-subtitle" value="THE OFFICIAL HUB OF JON AND JONNY KIRSCH RACING SAGA" class="modern-input w-full p-3 text-white" />
                    </div>
                    <div>
                      <label class="block text-sm font-medium text-slate-300 mb-1">Racing Season</label>
                      <input type="text" id="racing-season" value="2025" class="modern-input w-full p-3 text-white" />
                    </div>
                  </div>
                  
                  <div class="space-y-4">
                    <h4 class="font-semibold text-white border-b border-slate-600 pb-2">Contact Information</h4>
                    <div>
                      <label class="block text-sm font-medium text-slate-300 mb-1">Facebook URL</label>
                      <input type="url" id="facebook-url" value="https://www.facebook.com/share/1F1RTxz9xa/" class="modern-input w-full p-3 text-white" />
                    </div>
                    <div>
                      <label class="block text-sm font-medium text-slate-300 mb-1">TikTok Handle</label>
                      <input type="text" id="tiktok-handle" value="@redsracing" class="modern-input w-full p-3 text-white" />
                    </div>
                    <div>
                      <label class="block text-sm font-medium text-slate-300 mb-1">Copyright Year</label>
                      <input type="number" id="copyright-year" value="2025" class="modern-input w-full p-3 text-white" />
                    </div>
                  </div>
                </div>
                
                <div class="mt-6 flex justify-end">
                  <button id="save-content-btn" class="success-btn px-6 py-3 rounded-lg font-semibold flex items-center">
                    <i class="fas fa-globe mr-2"></i>Update Content
                  </button>
                </div>
              </div>
            </div>
            
            <!-- Advanced Section -->
            <div id="advanced-section" class="space-y-6" style="display: none">
              <div class="flex items-center justify-between">
                <h2 class="text-3xl font-bold text-white">
                  <i class="fas fa-tools text-yellow-300 mr-3"></i>
                  Advanced Tools
                </h2>
                <div class="flex items-center space-x-2">
                  <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                  <span class="text-green-400 text-sm font-medium">Available</span>
                </div>
              </div>

              <!-- TikTok Tools Card -->
              <div class="admin-card rounded-xl p-6">
                <h3 class="text-xl font-bold text-white mb-4">
                  <i class="fab fa-tiktok text-pink-400 mr-2"></i>
                  TikTok Tools
                </h3>
                <p class="text-slate-400 mb-4">Manage TikTok-related settings and embeds. These tools are visible on all devices.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div>
                    <label class="block text-sm font-medium text-slate-300 mb-1">TikTok Handle</label>
                    <input type="text" id="advanced-tiktok-handle" placeholder="@redsracing" class="modern-input w-full p-3 text-white" />
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-slate-300 mb-1">Sample Video URL (optional)</label>
                    <input type="url" id="advanced-tiktok-url" placeholder="https://www.tiktok.com/@user/video/123456" class="modern-input w-full p-3 text-white" />
                  </div>
                </div>
                <div class="mt-4 flex items-center justify-between">
                  <p class="text-slate-500 text-sm">Manage and save TikTok configuration to Firestore.</p>
                  <div class="space-x-2">
                    <button id="save-tiktok-btn" class="success-btn text-white px-4 py-2 rounded-lg text-sm font-semibold"><i class="fas fa-save mr-2"></i>Save</button>
                    <button id="preview-tiktok-btn" class="modern-btn text-white px-4 py-2 rounded-lg text-sm font-semibold"><i class="fas fa-eye mr-2"></i>Preview</button>
                  </div>
                </div>
                <!-- Inline Preview -->
                <div class="mt-6">
                  <h4 class="text-white font-semibold mb-2">Inline Preview</h4>
                  <div id="tiktok-inline-preview" class="bg-slate-800/50 border border-slate-700 rounded-lg p-4"></div>
                </div>
                <!-- TikTok Video Library -->
                <div class="mt-8">
                  <h4 class="text-white font-semibold mb-2">TikTok Video Library</h4>
                  <form id="add-tiktok-video-form" class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
                    <input type="url" id="new-tiktok-url" placeholder="https://www.tiktok.com/@user/video/123456" class="modern-input w-full p-2 text-white" required />
                    <input type="text" id="new-tiktok-title" placeholder="Optional title" class="modern-input w-full p-2 text-white" />
                    <button type="submit" class="success-btn text-white px-4 py-2 rounded text-sm font-semibold"><i class="fas fa-plus mr-1"></i>Add</button>
                  </form>
                  <div id="tiktok-video-list" class="space-y-2"></div>
                </div>
              </div>

              <!-- Role Management -->
              <div class="admin-card rounded-xl p-6">
                <h3 class="text-xl font-bold text-white mb-4">
                  <i class="fas fa-user-shield text-green-400 mr-2"></i>
                  Role Management
                </h3>
                <p class="text-slate-400 text-sm mb-4">Assign roles by email. Admin only for role changes.</p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-start">
                  <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-slate-300 mb-1">Email addresses (one per line)</label>
                    <textarea id="role-emails" class="modern-input w-full p-3 text-white resize-none" rows="5" placeholder="user1@example.com&#10;user2@example.com"></textarea>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-slate-300 mb-1">Role</label>
                    <select id="role-select" class="modern-input w-full p-2 text-white">
                      <option value="team-member">team-member</option>
                      <option value="TeamRedFollower">TeamRedFollower</option>
                      <option value="public-fan">public-fan</option>
                      <option value="admin">admin</option>
                    </select>
                    <button id="assign-role-btn" class="success-btn text-white px-4 py-2 rounded-lg text-sm font-semibold mt-3 w-full">
                      <i class="fas fa-user-check mr-2"></i>Assign Role(s)
                    </button>
                  </div>
                </div>
                <div class="mt-4">
                  <div id="role-results" class="text-sm text-slate-300"></div>
                </div>
              </div>

              <!-- Invitation Codes Manager -->
              <div class="admin-card rounded-xl p-6">
                <h3 class="text-xl font-bold text-white mb-4">
                  <i class="fas fa-key text-yellow-400 mr-2"></i>
                  Invitation Codes
                </h3>
                <div class="flex items-center justify-between mb-3">
                  <p class="text-slate-400 text-sm">Team-members and admins can view codes. Only admins can create codes.</p>
                  <div class="space-x-2">
                    <button id="refresh-invites-btn" class="modern-btn text-white px-3 py-2 rounded text-sm"><i class="fas fa-sync mr-1"></i>Refresh</button>
                  </div>
                </div>
                <div class="overflow-x-auto">
                  <table class="w-full text-left text-sm">
                    <thead>
                      <tr class="border-b border-slate-600">
                        <th class="p-2">Code</th>
                        <th class="p-2">Role</th>
                        <th class="p-2">Status</th>
                        <th class="p-2">Used By</th>
                        <th class="p-2">Used At</th>
                        <th class="p-2">Expires</th>
                      </tr>
                    </thead>
                    <tbody id="invites-table-body"></tbody>
                  </table>
                </div>
                <div class="mt-6 p-4 bg-slate-800/50 border border-slate-700/50 rounded-lg">
                  <h4 class="text-white font-semibold mb-3"><i class="fas fa-plus mr-2 text-yellow-400"></i>Create New Codes (Admin)</h4>
                  <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                    <div>
                      <label class="block text-xs text-slate-300 mb-1">Role</label>
                      <select id="new-code-role" class="modern-input w-full p-2 text-white">
                        <option value="team-member">team-member</option>
                        <option value="TeamRedFollower">TeamRedFollower</option>
                        <option value="public-fan">public-fan</option>
                      </select>
                    </div>
                    <div>
                      <label class="block text-xs text-slate-300 mb-1">Count</label>
                      <input type="number" id="new-code-count" min="1" value="5" class="modern-input w-full p-2 text-white" />
                    </div>
                    <div>
                      <label class="block text-xs text-slate-300 mb-1">Prefix (optional)</label>
                      <input type="text" id="new-code-prefix" placeholder="TEAM-" class="modern-input w-full p-2 text-white" />
                    </div>
                    <div>
                      <label class="block text-xs text-slate-300 mb-1">Expires (optional)</label>
                      <input type="date" id="new-code-expires" class="modern-input w-full p-2 text-white" />
                    </div>
                  </div>
                  <div class="mt-3 flex justify-end">
                    <button id="create-codes-btn" class="success-btn text-white px-4 py-2 rounded text-sm"><i class="fas fa-key mr-2"></i>Create</button>
                  </div>
                  <div id="create-codes-result" class="text-sm text-slate-300 mt-2"></div>
                </div>
              </div>
            </div>
            
            <!-- Quick Actions Footer -->
            <div class="admin-card rounded-xl p-6 mt-8">
              <h3 class="text-lg font-bold text-white mb-4">
                <i class="fas fa-bolt text-yellow-400 mr-2"></i>
                Quick Actions
              </h3>
              <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <button id="approve-all-btn" class="success-btn text-white px-4 py-3 rounded-lg text-sm font-semibold flex items-center justify-center">
                  <i class="fas fa-check mr-1"></i>Approve All
                </button>
                <button id="refresh-data-btn" class="modern-btn text-white px-4 py-3 rounded-lg text-sm font-semibold flex items-center justify-center">
                  <i class="fas fa-sync mr-1"></i>Refresh Data
                </button>
                <button id="export-data-btn" class="modern-btn text-white px-4 py-3 rounded-lg text-sm font-semibold flex items-center justify-center">
                  <i class="fas fa-download mr-1"></i>Export
                </button>
                <button id="cleanup-btn" class="danger-btn text-white px-4 py-3 rounded-lg text-sm font-semibold flex items-center justify-center">
                  <i class="fas fa-trash mr-1"></i>Cleanup
                </button>
              </div>
            </div>
            </div>
          </div>

          <!-- Dedicated Race Management Section -->
          <div id="race-section" class="space-y-6 hidden">
            <div class="admin-card rounded-xl p-6">
              <h2 class="text-2xl font-bold text-white mb-4"><i class="fas fa-flag-checkered text-green-400 mr-2"></i>Race Management</h2>
              <div class="flex justify-end mb-4">
                <button id="add-race-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-500 transition">Add New Race</button>
              </div>
              <div class="overflow-x-auto">
                <table class="w-full text-left modern-table">
                  <thead class="table-header">
                    <tr>
                      <th class="p-2">Date</th>
                      <th class="p-2">Name</th>
                      <th class="p-2">Status</th>
                      <th class="p-2">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="races-table-body"></tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Q&A Management Section -->
          <div id="qna-section" class="space-y-6 hidden">
            <div class="admin-card rounded-xl p-6">
              <div class="flex items-center justify-between mb-4">
                <h2 class="text-2xl font-bold text-white"><i class="fas fa-question-circle text-cyan-400 mr-2"></i>Q&A Management</h2>
                <button id="refresh-qna-btn" class="modern-btn text-white px-3 py-2 rounded text-sm"><i class="fas fa-sync mr-1"></i>Refresh</button>
              </div>
              <p class="text-slate-400 text-sm mb-4">Review questions submitted by fans. Add an answer and publish, or reject.</p>
              <div id="qna-management-card" class="space-y-4">
                <div id="qna-list" class="space-y-3"></div>
              </div>
            </div>
          </div>

          <!-- Videos Section (Approvals + Size Settings) -->
          <div id="videos-section" class="space-y-6 hidden">
            <div class="admin-card rounded-xl p-6">
              <div class="flex items-center justify-between mb-4">
                <h2 class="text-2xl font-bold text-white"><i class="fas fa-video text-pink-400 mr-2"></i>Video Approvals</h2>
                <button id="refresh-videos-btn" class="modern-btn text-white px-3 py-2 rounded text-sm"><i class="fas fa-sync mr-1"></i>Refresh</button>
              </div>
              <p class="text-slate-400 text-sm mb-4">Approve or reject submitted videos. Only unapproved items appear here.</p>
              <div id="video-approvals-list" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4"></div>
            </div>
            <div class="admin-card rounded-xl p-6">
              <h3 class="text-xl font-bold text-white mb-4"><i class="fas fa-ruler-combined text-yellow-400 mr-2"></i>Video Size Settings</h3>
              <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                  <label class="block text-sm font-medium text-slate-300 mb-1">Width (px)</label>
                  <input type="number" id="video-width" class="modern-input w-full p-2 text-white" placeholder="1280" />
                </div>
                <div>
                  <label class="block text-sm font-medium text-slate-300 mb-1">Height (px)</label>
                  <input type="number" id="video-height" class="modern-input w-full p-2 text-white" placeholder="720" />
                </div>
                <div>
                  <label class="block text-sm font-medium text-slate-300 mb-1">Aspect Ratio</label>
                  <select id="video-aspect" class="modern-input w-full p-2 text-white">
                    <option value="16:9">16:9</option>
                    <option value="4:3">4:3</option>
                    <option value="1:1">1:1</option>
                    <option value="9:16">9:16</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium text-slate-300 mb-1">Max Width (CSS)</label>
                  <input type="text" id="video-max-width" class="modern-input w-full p-2 text-white" placeholder="100%" />
                </div>
              </div>
              <div class="mt-4 flex justify-end">
                <button id="save-video-settings" class="success-btn px-4 py-2 rounded-lg text-white font-semibold"><i class="fas fa-save mr-2"></i>Save</button>
              </div>
            </div>
          </div>

          <!-- Admin Pages (CMS) Section -->
          <div id="admin-pages" class="space-y-6 hidden">
            <div class="admin-card rounded-xl p-6">
              <h2 class="text-2xl font-bold text-white mb-2">
                <i class="fas fa-file-pen text-yellow-300 mr-2"></i>
                Page Management
              </h2>
              <p class="text-slate-400 text-sm mb-3">Edit site pages and sections (hero, tips, quiz, etc). Choose the page slug in the CMS panel below.</p>
              <!-- Visible fallback so this area is never empty -->
              <div id="cms-fallback" class="bg-slate-800/50 border border-slate-700/50 rounded-lg p-4">
                <div class="text-slate-300 text-sm mb-2">CMS Editor</div>
                <p class="text-slate-400 text-sm mb-3">Click the button to load the editor if it does not appear automatically.</p>
                <button id="cms-load-btn" class="modern-btn text-white px-3 py-2 rounded text-sm"><i class="fas fa-pen-to-square mr-2"></i>Load Editor</button>
              </div>
            </div>
          </div>

          <!-- Error Logs Section -->
          <div id="logs-section" class="space-y-6 hidden">
            <div class="admin-card rounded-xl p-6">
              <div class="flex items-center justify-between mb-3">
                <h2 class="text-2xl font-bold text-white"><i class="fas fa-bug text-red-400 mr-2"></i>Error Logs</h2>
                <div class="space-x-2">
                  <button id="refresh-logs-btn" class="modern-btn text-white px-3 py-2 rounded text-sm"><i class="fas fa-sync mr-1"></i>Refresh</button>
                </div>
              </div>
              <div class="overflow-x-auto">
                <table class="w-full text-left modern-table text-sm">
                  <thead class="table-header">
                    <tr>
                      <th class="p-2">Time</th>
                      <th class="p-2">Level</th>
                      <th class="p-2">Message</th>
                      <th class="p-2">Page</th>
                      <th class="p-2">User</th>
                    </tr>
                  </thead>
                  <tbody id="logs-table-body"></tbody>
                </table>
              </div>
              <p class="text-slate-500 text-xs mt-2">Frontend errors are sampled and stored as a fallback when developer tools are not available.</p>
            </div>
          </div>
        </div>
      </main>
    </div>
        
    <!-- Modern Footer -->
    <footer class="admin-glass border-t border-white/10 py-4">
      <div class="container mx-auto px-4 lg:px-6">
        <div class="flex items-center justify-between">
          <p class="text-slate-400 text-sm">
            ¬© <span id="year"></span> RedsRacing #8 - Admin Command Center
          </p>
          <div class="flex items-center space-x-4 text-sm">
            <div class="flex items-center space-x-2">
              <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
              <span class="text-slate-400">All systems operational</span>
            </div>
            <div class="text-slate-500">v2.0.1</div>
          </div>
        </div>
      </div>
    </footer>

    <!-- Toast Container -->
    <div id="admin-toast" class="hidden fixed top-4 right-4 bg-slate-900 text-white px-4 py-3 rounded-lg shadow-lg border border-slate-700 z-50"></div>

    <!-- Modern Admin Scripts -->
    <!-- Bootstrap Firebase early so all modules see a default app -->
    <script type="module">
      import { initializeApp, getApps } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
      const cfg = {
        apiKey: "AIzaSyARFiFCadGKFUc_s6x3qNX8F4jsVawkzVg",
        authDomain: "redsracing-a7f8b.firebaseapp.com",
        projectId: "redsracing-a7f8b",
        storageBucket: "redsracing-a7f8b.firebasestorage.app",
        messagingSenderId: "517034606151",
        appId: "1:517034606151:web:24cae262e1d98832757b62"
      };
      if (getApps().length === 0) initializeApp(cfg);
    </script>
    <script>
      // Wire advanced actions after DOM load
      document.addEventListener('DOMContentLoaded', function(){
        try { wireAdvancedActions(); } catch {}
        try {
          const btn1 = document.getElementById('save-roster-btn');
          if (btn1) btn1.addEventListener('click', saveRosterSettings);
          const btn2 = document.getElementById('save-stats-btn');
          if (btn2) btn2.addEventListener('click', saveHomepageStats);
          const btn3 = document.getElementById('save-content-btn');
          if (btn3) btn3.addEventListener('click', saveContentSettings);
        } catch {}
      });
    </script>
    <script src="vendors.js"></script>
    <script type="module" src="assets/js/auth-guard.js"></script>
    <script type="module" src="navigation.js"></script>
    <script type="module" src="assets\js\redsracing-dashboard.js"></script>
    <script type="module" src="assets/js/cms-admin.js?v=20251002-2"></script>
    
    <script>
      // Modern Admin Console JavaScript
      (function() {
        'use strict';
        
        // --- Firebase initialization helpers (single source of truth) ---
        const FIREBASE_CONFIG = {
          apiKey: "AIzaSyARFiFCadGKFUc_s6x3qNX8F4jsVawkzVg",
          authDomain: "redsracing-a7f8b.firebaseapp.com",
          projectId: "redsracing-a7f8b",
          storageBucket: "redsracing-a7f8b.firebasestorage.app",
          messagingSenderId: "517034606151",
          appId: "1:517034606151:web:24cae262e1d98832757b62"
        };
        
        async function ensureDefaultApp() {
          const appModule = await import('https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js');
          const { getApps, initializeApp } = appModule;
          if (getApps().length === 0) {
            initializeApp(FIREBASE_CONFIG);
          }
          return appModule.getApps()[0];
        }
        
        async function getUserRole() {
          try {
            const { getAuth } = await import('https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js');
            const auth = getAuth();
            if (!auth.currentUser) return null;
            const token = await auth.currentUser.getIdTokenResult(true);
            return token?.claims?.role || null;
          } catch (_) { return null; }
        }
        
        function isModeratorRole(role) {
          return role === 'team-member' || role === 'admin';
        }
        
        // Enhanced loading with modern animations
        function showDashboard() {
          const loader = document.getElementById('loading-state');
          const dashboard = document.getElementById('dashboard-content');
          
          if (loader) {
            loader.style.opacity = '0';
            loader.style.transform = 'scale(0.8)';
            setTimeout(() => loader.remove(), 300);
          }
          
          if (dashboard) {
            dashboard.classList.remove('hidden');
            dashboard.style.opacity = '0';
            dashboard.style.transform = 'translateY(20px)';
            
            // Smooth entrance animation
            setTimeout(() => {
              dashboard.style.transition = 'all 0.5s ease-out';
              dashboard.style.opacity = '1';
              dashboard.style.transform = 'translateY(0)';
            }, 100);
            
            // Animate statistics counters
            animateCounters();
          }
        }
        
        // Animate number counters
        function animateCounters() {
          const counters = document.querySelectorAll('.animated-counter');
          counters.forEach(counter => {
            const target = parseInt(counter.textContent) || 0;
            let current = 0;
            const increment = target / 20;
            const timer = setInterval(() => {
              current += increment;
              if (current >= target) {
                counter.textContent = target;
                clearInterval(timer);
                counter.classList.add('pulse-glow');
              } else {
                counter.textContent = Math.ceil(current);
              }
            }, 50);
          });
        }
        
        // Initialize sidebar navigation with section switching
        function initNavigation() {
          const navItems = document.querySelectorAll('.nav-item');
          
          navItems.forEach(item => {
            item.addEventListener('click', (e) => {
              const href = item.getAttribute('href') || '';
              // Allow normal navigation for non-hash links (e.g., settings.html)
              if (!href.startsWith('#')) {
                return; // do not prevent default; let browser navigate
              }
              e.preventDefault();
              
              // Remove active class from all items
              navItems.forEach(nav => nav.classList.remove('active'));
              // Add active class to clicked item
              item.classList.add('active');
              
              // Handle section switching
              if (href === '#gallery-approvals') {
                showGalleryApprovals();
              } else if (href === '#advanced') {
                showAdvanced();
              } else if (href === '#race') {
                showRace();
              } else if (href === '#media') {
                showMedia();
              } else if (href === '#qna') {
                showQnA();
              } else if (href === '#admin-pages') {
                showAdminPages();
              } else if (href === '#logs') {
                showLogs();
              } else {
                showOverview();
              }
            });
          });
        }
        
        // Section display functions
        function showOverview() {
          hideAllSections();
          const overview = document.getElementById('dashboard-content');
          if (overview) {
            overview.classList.remove('hidden');
            overview.style.display = 'block';
          }
        }
        
        function showGalleryApprovals() {
          hideAllSections();
          const approvals = document.getElementById('gallery-approvals');
          if (approvals) {
            approvals.classList.remove('hidden');
            approvals.style.display = 'block';
            // Show the photo approval card
            const photoCard = document.getElementById('photo-approval-card');
            if (photoCard) {
              photoCard.style.display = 'block';
            }
          }
        }

        function showRace() {
          hideAllSections();
          const race = document.getElementById('race-section');
          if (race) {
            race.classList.remove('hidden');
            race.style.display = 'block';
            try { loadRaceTable(); } catch(_) {}
          }
        }

        async function showLogs() {
          hideAllSections();
          const logs = document.getElementById('logs-section');
          if (logs) {
            logs.classList.remove('hidden');
            logs.style.display = 'block';
          }
          await refreshLogsUI();
        }
        
        function showJonnyApprovals() {
          showGalleryApprovals(); // For now, same as gallery approvals
          // TODO: Add separate Jonny approvals section
        }
        
        function showAdvanced() {
          hideAllSections();
          const adv = document.getElementById('advanced-section');
          if (adv) {
            adv.classList.remove('hidden');
            adv.style.display = 'block';
            // Load invites and TikTok list when Advanced is shown
            try { refreshInvitesUI(); } catch(_) {}
            try { refreshTikTokList(); } catch(_) {}
          }
        }
        
        function showSettings() {
          hideAllSections();
          let settingsSection = document.getElementById('settings-section');
          if (!settingsSection) {
            settingsSection = createSettingsSection();
          }
          if (settingsSection) {
            settingsSection.classList.remove('hidden');
            settingsSection.style.display = 'block';
          }
          // Load settings data when opening
          try { loadSiteSettings(); } catch(_) {}
        }
        
        function hideAllSections() {
          const sections = ['dashboard-content', 'gallery-approvals', 'settings-section', 'advanced-section', 'race-section', 'logs-section', 'admin-pages', 'qna-section', 'videos-section'];
          sections.forEach(id => {
            const section = document.getElementById(id);
            if (section) {
              section.classList.add('hidden');
              section.style.display = 'none';
            }
          });
        }
        
        // Create settings section
        function createSettingsSection() {
          let settingsSection = document.getElementById('settings-section');
          if (settingsSection) return settingsSection;
          
          settingsSection = document.createElement('div');
          settingsSection.id = 'settings-section';
          settingsSection.className = 'space-y-6 hidden';
          settingsSection.innerHTML = `
            <div class="flex items-center justify-between">
              <h2 class="text-2xl font-bold text-white">
                <i class="fas fa-cog text-slate-400 mr-2"></i>
                Admin Settings
              </h2>
            </div>
            
            <!-- Site Configuration -->
            <div class="admin-card rounded-xl p-6">
              <h3 class="text-lg font-bold text-white mb-4">
                <i class="fas fa-globe text-blue-400 mr-2"></i>
                Site Configuration
              </h3>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-slate-300 mb-2">Site Title</label>
                  <input type="text" value="RedsRacing #8" class="modern-input w-full px-3 py-2 text-white">
                </div>
                <div>
                  <label class="block text-sm font-medium text-slate-300 mb-2">Racing Numbers</label>
                  <input type="text" value="#8 & #88" class="modern-input w-full px-3 py-2 text-white">
                </div>
                <div>
                  <label class="block text-sm font-medium text-slate-300 mb-2">Season Year</label>
                  <input type="text" value="2025" class="modern-input w-full px-3 py-2 text-white">
                </div>
                <div>
                  <label class="block text-sm font-medium text-slate-300 mb-2">Team Status</label>
                  <select class="modern-input w-full px-3 py-2 text-white">
                    <option>Active Racing Season</option>
                    <option>Off Season</option>
                    <option>Maintenance Mode</option>
                  </select>
                </div>
              </div>
              <div class="mt-4">
                <button class="success-btn px-4 py-2 rounded-lg text-white font-semibold">
                  <i class="fas fa-save mr-2"></i>Save Changes
                </button>
              </div>
            </div>
            
            <!-- User Management -->
            <div class="admin-card rounded-xl p-6">
              <h3 class="text-lg font-bold text-white mb-4">
                <i class="fas fa-users text-green-400 mr-2"></i>
                User Management
              </h3>
              <div class="space-y-4">
                <div class="flex items-center justify-between">
                  <span class="text-slate-300">Auto-approve new registrations</span>
                  <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" class="sr-only peer">
                    <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                  </label>
                </div>
                <div class="flex items-center justify-between">
                  <span class="text-slate-300">Require admin approval for uploads</span>
                  <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" checked class="sr-only peer">
                    <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                  </label>
                </div>
                <div class="flex items-center justify-between">
                  <span class="text-slate-300">Enable public registration</span>
                  <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" checked class="sr-only peer">
                    <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                  </label>
                </div>
              </div>
            </div>
            
            <!-- Security Settings -->
            <div class="admin-card rounded-xl p-6">
              <h3 class="text-lg font-bold text-white mb-4">
                <i class="fas fa-shield-alt text-red-400 mr-2"></i>
                Security & Privacy
              </h3>
              <div class="space-y-4">
                <div>
                  <button class="danger-btn px-4 py-2 rounded-lg text-white font-semibold">
                    <i class="fas fa-key mr-2"></i>Reset All API Keys
                  </button>
                </div>
                <div>
                  <button class="modern-btn px-4 py-2 rounded-lg text-white font-semibold">
                    <i class="fas fa-download mr-2"></i>Export User Data
                  </button>
                </div>
                <div>
                  <button class="modern-btn px-4 py-2 rounded-lg text-white font-semibold">
                    <i class="fas fa-trash mr-2"></i>Clear System Logs
                  </button>
                </div>
              </div>
            </div>
          `;
          
          const main = document.querySelector('main .p-4');
          if (main) {
            main.appendChild(settingsSection);
          }
          
          return settingsSection;
        }
        function showAdminPages() {
          hideAllSections();
          const sec = document.getElementById('admin-pages');
          if (sec) {
            sec.classList.remove('hidden');
            sec.style.display = 'block';
            try { if (window.initCMSAdmin) window.initCMSAdmin(); } catch(_) {}
            // Fallback button to manually load
            const btn = document.getElementById('cms-load-btn');
            if (btn) btn.onclick = () => { try { if (window.initCMSAdmin) window.initCMSAdmin(); } catch(_) {} };
          }
        }

        function showQnA() {
          hideAllSections();
          const sec = document.getElementById('qna-section');
          if (sec) {
            sec.classList.remove('hidden');
            sec.style.display = 'block';
            try { loadQnaPending(); } catch(_) {}
          }
        }

        function showVideos() {
          hideAllSections();
          const sec = document.getElementById('videos-section');
          if (sec) {
            sec.classList.remove('hidden');
            sec.style.display = 'block';
            try { loadVideoPending(); } catch(_) {}
            try { loadVideoSettings(); } catch(_) {}
          }
        }

        // Media shows both gallery approvals and videos panels together
        function showMedia() {
          hideAllSections();
          const gal = document.getElementById('gallery-approvals');
          const vid = document.getElementById('videos-section');
          if (gal) {
            gal.classList.remove('hidden');
            gal.style.display = 'block';
            try { loadPendingPhotos(); } catch(_) {}
          }
          if (vid) {
            vid.classList.remove('hidden');
            vid.style.display = 'block';
            try { loadVideoPending(); } catch(_) {}
            try { loadVideoSettings(); } catch(_) {}
          }
        }
        
        // Settings: load and save

        // Race table loader (inline) ‚Äì ensures the editor is visible under Race Management
        async function loadRaceTable() {
          try {
            const { getFirestore, collection, getDocs, query, orderBy } = await import('https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js');
            const app = await ensureDefaultApp();
            const db = getFirestore(app);
            const tbody = document.getElementById('races-table-body');
            if (!tbody) return;
            tbody.innerHTML = '';
            const q = query(collection(db, 'races'), orderBy('date','asc'));
            const snap = await getDocs(q);
            if (snap.empty) {
              const tr = document.createElement('tr');
              tr.innerHTML = '<td class="p-3 text-slate-400" colspan="4">No races added yet.</td>';
              tbody.appendChild(tr);
              return;
            }
            snap.forEach(d => {
              const v = d.data() || {};
              const dateStr = v.date ? new Date(v.date).toLocaleDateString() : 'TBD';
              const name = v.name || 'Unnamed Race';
              const status = v.status || 'upcoming';
              const tr = document.createElement('tr');
              tr.className = 'border-b border-slate-700/50 hover:bg-slate-800/40';
              tr.innerHTML = `
                <td class="p-3">${dateStr}</td>
                <td class="p-3">${name}</td>
                <td class="p-3 capitalize">${status}</td>
                <td class="p-3 text-right whitespace-nowrap">
                  <button class="edit-race-btn bg-blue-600 text-white px-3 py-1.5 rounded text-xs hover:bg-blue-500 transition mr-2" data-id="${d.id}">Edit</button>
                  <button class="delete-race-btn bg-red-600 text-white px-3 py-1.5 rounded text-xs hover:bg-red-500 transition" data-id="${d.id}">Delete</button>
                </td>`;
              tbody.appendChild(tr);
            });

            // Attach event delegation for edit/delete
            try {
              const container = document.getElementById('races-table-body');
              if (container && !container.__raceDelegated) {
                container.__raceDelegated = true;
                container.addEventListener('click', (e) => {
                  const editBtn = e.target.closest('.edit-race-btn');
                  const delBtn = e.target.closest('.delete-race-btn');
                  if (editBtn) {
                    const id = editBtn.getAttribute('data-id');
                    if (id) openRaceEditor(id);
                  } else if (delBtn) {
                    const id = delBtn.getAttribute('data-id');
                    if (id) deleteRaceById(id);
                  }
                });
              }
            } catch(_) {}
          } catch (e) { console.error('Failed to load races', e); }
        }

        // Race Editor Modal
        async function openRaceEditor(raceId) {
          try {
            const { getFirestore, doc, getDoc } = await import('https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js');
            const app = await ensureDefaultApp();
            const db = getFirestore(app);
            let data = { name: '', status: 'upcoming', date: '' };
            if (raceId) {
              const snap = await getDoc(doc(db, 'races', raceId));
              if (snap.exists()) {
                const v = snap.data() || {};
                data = {
                  name: v.name || '',
                  status: v.status || 'upcoming',
                  date: v.date ? new Date(v.date) : null
                };
              }
            }
            renderRaceModal(raceId, data);
          } catch (e) { console.error('Open race editor failed', e); }
        }

        function renderRaceModal(raceId, data) {
          closeRaceModal();
          const overlay = document.createElement('div');
          overlay.id = 'race-editor-overlay';
          overlay.className = 'fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4';
          const modal = document.createElement('div');
          modal.id = 'race-editor-modal';
          modal.className = 'admin-card rounded-xl p-6 w-full max-w-xl border border-slate-700/60';
          const dateVal = data.date ? new Date(data.date).toISOString().slice(0,10) : '';
          modal.innerHTML = `
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-xl font-bold text-white">${raceId ? 'Edit Race' : 'Add Race'}</h3>
              <button class="danger-btn px-2 py-1 text-sm" onclick="window.closeRaceModal()"><i class='fas fa-times'></i></button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <label class="block text-sm text-slate-300 mb-1">Date</label>
                <input type="date" id="race-edit-date" class="modern-input w-full p-2 text-white" value="${dateVal}" />
              </div>
              <div class="md:col-span-2">
                <label class="block text-sm text-slate-300 mb-1">Name</label>
                <input type="text" id="race-edit-name" class="modern-input w-full p-2 text-white" value="${(data.name||'').replace(/"/g,'&quot;')}" placeholder="Race Name" />
              </div>
              <div>
                <label class="block text-sm text-slate-300 mb-1">Status</label>
                <select id="race-edit-status" class="modern-input w-full p-2 text-white">
                  <option value="upcoming" ${data.status==='upcoming'?'selected':''}>Upcoming</option>
                  <option value="active" ${data.status==='active'?'selected':''}>Active</option>
                  <option value="completed" ${data.status==='completed'?'selected':''}>Completed</option>
                </select>
              </div>
            </div>
            <div class="mt-6 flex items-center justify-end space-x-2">
              ${raceId ? '<button class="danger-btn px-4 py-2 rounded" onclick="window.deleteRaceById(\'' + raceId + '\')"><i class=\'fas fa-trash mr-1\'></i>Delete</button>' : ''}
              <button class="modern-btn px-4 py-2 rounded" onclick="window.closeRaceModal()">Cancel</button>
              <button class="success-btn px-4 py-2 rounded" onclick="window.saveRaceEdits('${raceId||''}')"><i class='fas fa-save mr-1'></i>Save</button>
            </div>
          `;
          overlay.appendChild(modal);
          document.body.appendChild(overlay);
          window.closeRaceModal = closeRaceModal;
          window.saveRaceEdits = saveRaceEdits;
          window.deleteRaceById = deleteRaceById;
        }

        function closeRaceModal() {
          const o = document.getElementById('race-editor-overlay');
          if (o && o.parentNode) o.parentNode.removeChild(o);
        }

        async function saveRaceEdits(raceId) {
          try {
            const { getFirestore, doc, setDoc, updateDoc } = await import('https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js');
            const app = await ensureDefaultApp();
            const db = getFirestore(app);
            const name = document.getElementById('race-edit-name')?.value?.trim();
            const dateStr = document.getElementById('race-edit-date')?.value;
            const status = document.getElementById('race-edit-status')?.value || 'upcoming';
            if (!name || !dateStr) { showToast('Please provide name and date', 'error'); return; }
            const payload = { name, status, date: new Date(dateStr) };
            if (raceId) {
              await updateDoc(doc(db, 'races', raceId), payload);
            } else {
              await setDoc(doc(db, 'races', crypto.randomUUID()), { ...payload, createdAt: new Date() });
            }
            showToast('Race saved');
            closeRaceModal();
            await loadRaceTable();
            await loadRealFirebaseData();
          } catch (e) { console.error('Save race failed', e); showToast('Failed to save race', 'error'); }
        }

        async function deleteRaceById(raceId) {
          if (!raceId) return; if (!confirm('Delete this race?')) return;
          try {
            const { getFirestore, doc, deleteDoc } = await import('https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js');
            const app = await ensureDefaultApp();
            const db = getFirestore(app);
            await deleteDoc(doc(db, 'races', raceId));
            showToast('Race deleted');
            closeRaceModal();
            await loadRaceTable();
            await loadRealFirebaseData();
          } catch (e) { console.error('Delete race failed', e); showToast('Failed to delete race', 'error'); }
        }

        // Q&A: load pending submissions
        async function loadQnaPending() {
          // Render a header and buckets for Pending and Published
          try {
            const list = document.getElementById('qna-list');
            if (list) list.innerHTML = '<h3 class="text-white font-semibold mb-2">Pending Questions</h3>';
          } catch(_) {}
          try {
            const role = await getUserRole();
            const { getFirestore, collection, query, where, orderBy, getDocs } = await import('https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js');
            const app = await ensureDefaultApp();
            const db = getFirestore(app);
            const list = document.getElementById('qna-list');
            if (!list) return;
            list.innerHTML = '';
            const q = query(collection(db, 'qna_submissions'), where('status','==','submitted'), orderBy('submittedAt','desc'));
            const snap = await getDocs(q);
            if (snap.empty) {
              const empty = document.createElement('div');
              empty.className = 'text-slate-400 text-sm';
              empty.textContent = 'No questions pending approval.';
              list.appendChild(empty);
              return;
            }
            snap.forEach(d => {
              const v = d.data() || {};
              const card = document.createElement('div');
              card.className = 'bg-slate-800/50 border border-slate-700/50 rounded-lg p-4';
              const elId = d.id.replace(/[^a-zA-Z0-9_-]/g,'');
              card.innerHTML = `
                <div class="text-slate-300 text-sm mb-2">Submitted by ${v.submitterName || 'Anonymous'}</div>
                <div class="text-white font-medium mb-3">${(v.question||'').replace(/</g,'&lt;')}</div>
                <label class="block text-xs text-slate-400 mb-1">Answer</label>
                <textarea id="answer-${elId}" rows="3" class="modern-input w-full p-2 text-white resize-none" placeholder="Write your answer..."></textarea>
                <div class="mt-3 flex items-center justify-end space-x-2">
                  <button class="danger-btn px-3 py-1.5 rounded text-sm" onclick="window.rejectQna('${d.id}')"><i class='fas fa-times mr-1'></i>Reject</button>
                  <button class="success-btn px-3 py-1.5 rounded text-sm" onclick="window.publishQna('${d.id}')"><i class='fas fa-check mr-1'></i>Publish</button>
                </div>
              `;
              list.appendChild(card);
            });
          } catch(e) { console.error('Failed to load Q&A', e); }
        }

        window.publishQna = async function(docId) {
          try {
            const { getFirestore, doc, updateDoc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js');
            const { getAuth } = await import('https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js');
            const app = await ensureDefaultApp();
            const db = getFirestore(app);
            const auth = getAuth();
            const elId = docId.replace(/[^a-zA-Z0-9_-]/g,'');
            const ans = document.getElementById(`answer-${elId}`)?.value?.trim();
            if (!ans) { showToast('Please provide an answer before publishing', 'error'); return; }
            await updateDoc(doc(db, 'qna_submissions', docId), {
              status: 'published',
              answer: ans,
              answeredAt: new Date(),
              answeredBy: auth.currentUser?.email || 'admin'
            });
            showToast('Question published');
            loadQnaPending();
            loadQnaPublished();
          } catch(e) { console.error('Publish Q&A failed', e); showToast('Failed to publish', 'error'); }
        }

        // Also load recently published to give context
        async function loadQnaPublished() {
          try {
            const { getFirestore, collection, getDocs, query, where, orderBy, limit } = await import('https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js');
            const app = await ensureDefaultApp();
            const db = getFirestore(app);
            const list = document.getElementById('qna-list');
            if (!list) return;
            const header = document.createElement('div');
            header.className = 'mt-6 text-slate-300 font-semibold';
            header.textContent = 'Recently Published';
            list.appendChild(header);
            const wrap = document.createElement('div');
            wrap.className = 'mt-2 space-y-2';
            list.appendChild(wrap);
            const q = query(collection(db, 'qna_submissions'), where('status','==','published'), orderBy('answeredAt','desc'), limit(6));
            const snap = await getDocs(q);
            if (snap.empty) {
              const p = document.createElement('div'); p.className = 'text-slate-500 text-sm'; p.textContent = 'No published Q&A yet.'; wrap.appendChild(p); return;
            }
            snap.forEach(d => {
              const v = d.data() || {};
              const card = document.createElement('div');
              card.className = 'bg-slate-800/40 border border-slate-700/40 rounded p-3';
              card.innerHTML = `<div class="text-slate-300">Q: ${(v.question||'').replace(/</g,'&lt;')}</div><div class="text-white mt-1">A: ${(v.answer||'').replace(/</g,'&lt;')}</div>`;
              wrap.appendChild(card);
            });
          } catch(_) {}
        }

        window.rejectQna = async function(docId) {
          if (!confirm('Reject this question?')) return;
          try {
            const { getFirestore, doc, updateDoc } = await import('https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js');
            const app = await ensureDefaultApp();
            const db = getFirestore(app);
            await updateDoc(doc(db, 'qna_submissions', docId), { status: 'rejected', rejectedAt: new Date() });
            showToast('Question rejected');
            loadQnaPending();
          } catch(e) { console.error('Reject Q&A failed', e); showToast('Failed to reject', 'error'); }
        }

        // Videos: approvals + size settings
        async function loadVideoPending() {
          try {
            const { getFirestore, collection, getDocs } = await import('https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js');
            const app = await ensureDefaultApp();
            const db = getFirestore(app);
            const container = document.getElementById('video-approvals-list');
            if (!container) return;
            container.innerHTML = '';
            const snap = await getDocs(collection(db, 'jonny_videos'));
            const pending = [];
            snap.forEach(d => { const v = d.data()||{}; if (v.approved !== true) pending.push({ id: d.id, ...v }); });
            if (!pending.length) {
              const empty = document.createElement('div');
              empty.className = 'text-slate-400 text-sm col-span-full';
              empty.textContent = 'No videos pending approval.';
              container.appendChild(empty);
              return;
            }
            pending.forEach(v => {
              const card = document.createElement('div');
              card.className = 'bg-slate-800/50 border border-slate-700/50 rounded-lg p-4 flex flex-col';
              const safeTitle = (v.title||'Untitled').replace(/</g,'&lt;');
              const safeUrl = (v.url||'').replace(/"/g,'&quot;');
              card.innerHTML = `
                <div class="font-semibold text-white mb-2 truncate" title="${safeTitle}">${safeTitle}</div>
                ${v.url ? `<a href="${safeUrl}" target="_blank" class="text-neon-yellow text-sm mb-3">Open Video</a>` : ''}
                <div class="mt-auto flex items-center justify-end space-x-2">
                  <button class="danger-btn px-3 py-1.5 rounded text-sm" onclick="window.rejectVideo('${v.id}')"><i class='fas fa-times mr-1'></i>Reject</button>
                  <button class="success-btn px-3 py-1.5 rounded text-sm" onclick="window.approveVideo('${v.id}')"><i class='fas fa-check mr-1'></i>Approve</button>
                </div>
              `;
              container.appendChild(card);
            });
          } catch(e) { console.error('Failed to load video approvals', e); }
        }

        window.approveVideo = async function(docId) {
          try {
            const { getFirestore, doc, updateDoc } = await import('https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js');
            const app = await ensureDefaultApp();
            const db = getFirestore(app);
            await updateDoc(doc(db, 'jonny_videos', docId), { approved: true, approvedAt: new Date() });
            showToast('Video approved');
            loadVideoPending();
          } catch(e) { console.error('Approve video failed', e); showToast('Failed to approve', 'error'); }
        }

        window.rejectVideo = async function(docId) {
          if (!confirm('Reject and delete this video?')) return;
          try {
            const { getFirestore, doc, deleteDoc } = await import('https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js');
            const app = await ensureDefaultApp();
            const db = getFirestore(app);
            await deleteDoc(doc(db, 'jonny_videos', docId));
            showToast('Video rejected');
            loadVideoPending();
          } catch(e) { console.error('Reject video failed', e); showToast('Failed to reject', 'error'); }
        }

        async function loadVideoSettings() {
          try {
            const { getFirestore, doc, getDoc } = await import('https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js');
            const app = await ensureDefaultApp();
            const db = getFirestore(app);
            const ref = doc(db, 'config', 'videos');
            const snap = await getDoc(ref);
            const v = (snap.exists() ? snap.data() : {}) || {};
            const w = document.getElementById('video-width'); if (w) w.value = v.width || '';
            const h = document.getElementById('video-height'); if (h) h.value = v.height || '';
            const a = document.getElementById('video-aspect'); if (a) a.value = v.aspect || '16:9';
            const mw = document.getElementById('video-max-width'); if (mw) mw.value = v.maxWidth || '100%';
          } catch(e) { console.error('Load video settings failed', e); }
        }

        async function saveVideoSettings() {
          try {
            const role = await getUserRole();
            if (!isModeratorRole(role)) { showToast('Team-member or admin only', 'error'); return; }
            const { getFirestore, doc, setDoc } = await import('https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js');
            const app = await ensureDefaultApp();
            const db = getFirestore(app);
            const payload = {
              width: Number(document.getElementById('video-width')?.value || 0) || null,
              height: Number(document.getElementById('video-height')?.value || 0) || null,
              aspect: document.getElementById('video-aspect')?.value || '16:9',
              maxWidth: document.getElementById('video-max-width')?.value || '100%'
            };
            await setDoc(doc(db, 'config', 'videos'), payload, { merge: true });
            showToast('Video settings saved');
          } catch(e) { console.error('Save video settings failed', e); showToast('Failed to save settings', 'error'); }
        }
        async function loadSiteSettings() {
          try {
            const { getFirestore, doc, getDoc } = await import('https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js');
            const db = getFirestore();
            const snap = await getDoc(doc(db, 'config', 'site'));
            if (!snap.exists()) return;
            const v = snap.data() || {};
            // Roster
            try {
              if (v.jon) {
                if (document.getElementById('jon-number')) document.getElementById('jon-number').value = v.jon.number || '';
                if (document.getElementById('jon-years')) document.getElementById('jon-years').value = v.jon.years || '';
                if (document.getElementById('jon-wins')) document.getElementById('jon-wins').value = v.jon.wins || '';
                if (document.getElementById('jon-podiums')) document.getElementById('jon-podiums').value = v.jon.podiums || '';
                if (document.getElementById('jon-bio')) document.getElementById('jon-bio').value = v.jon.bio || '';
              }
              if (v.jonny) {
                if (document.getElementById('jonny-number')) document.getElementById('jonny-number').value = v.jonny.number || '';
                if (document.getElementById('jonny-years')) document.getElementById('jonny-years').value = v.jonny.years || '';
                if (document.getElementById('jonny-wins')) document.getElementById('jonny-wins').value = v.jonny.wins || '';
                if (document.getElementById('jonny-championships')) document.getElementById('jonny-championships').value = v.jonny.championships || '';
                if (document.getElementById('jonny-bio')) document.getElementById('jonny-bio').value = v.jonny.bio || '';
              }
              // Homepage stats
              if (v.homepage) {
                if (document.getElementById('homepage-years')) document.getElementById('homepage-years').value = v.homepage.years || '';
                if (document.getElementById('homepage-wins')) document.getElementById('homepage-wins').value = v.homepage.wins || '';
                if (document.getElementById('homepage-numbers')) document.getElementById('homepage-numbers').value = v.homepage.numbers || '';
                if (document.getElementById('homepage-users')) document.getElementById('homepage-users').value = v.homepage.users || '';
              }
              // Content
              if (v.content) {
                if (document.getElementById('hero-title')) document.getElementById('hero-title').value = v.content.heroTitle || '';
                if (document.getElementById('hero-subtitle')) document.getElementById('hero-subtitle').value = v.content.heroSubtitle || '';
                if (document.getElementById('racing-season')) document.getElementById('racing-season').value = v.content.season || '';
              }
              // Socials
              if (v.social) {
                if (document.getElementById('facebook-url')) document.getElementById('facebook-url').value = v.social.facebook || '';
                if (document.getElementById('tiktok-handle')) document.getElementById('tiktok-handle').value = v.social.tiktok || '';
              }
              if (v.content && document.getElementById('copyright-year')) document.getElementById('copyright-year').value = v.content.copyright || '';
            } catch (_) {}
          } catch (e) { console.warn('Failed to load site settings', e); }
        }

        async function saveRosterSettings() {
          try {
            const { getFirestore, doc, setDoc } = await import('https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js');
            const db = getFirestore();
            const payload = {
              jon: {
                number: document.getElementById('jon-number')?.value || null,
                years: Number(document.getElementById('jon-years')?.value || 0) || 0,
                wins: Number(document.getElementById('jon-wins')?.value || 0) || 0,
                podiums: Number(document.getElementById('jon-podiums')?.value || 0) || 0,
                bio: document.getElementById('jon-bio')?.value || null,
              },
              jonny: {
                number: document.getElementById('jonny-number')?.value || null,
                years: Number(document.getElementById('jonny-years')?.value || 0) || 0,
                wins: Number(document.getElementById('jonny-wins')?.value || 0) || 0,
                championships: Number(document.getElementById('jonny-championships')?.value || 0) || 0,
                bio: document.getElementById('jonny-bio')?.value || null,
              },
            };
            await setDoc(doc(db, 'config', 'site'), payload, { merge: true });
            showToast('Roster saved');
          } catch (e) { showToast('Failed to save roster', 'error'); }
        }

        async function saveHomepageStats() {
          try {
            const { getFirestore, doc, setDoc } = await import('https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js');
            const db = getFirestore();
            const payload = {
              homepage: {
                years: Number(document.getElementById('homepage-years')?.value || 0) || 0,
                wins: Number(document.getElementById('homepage-wins')?.value || 0) || 0,
                numbers: document.getElementById('homepage-numbers')?.value || null,
                users: Number(document.getElementById('homepage-users')?.value || 0) || 0,
              },
            };
            await setDoc(doc(db, 'config', 'site'), payload, { merge: true });
            showToast('Homepage stats saved');
          } catch (e) { showToast('Failed to save homepage stats', 'error'); }
        }

        async function saveContentSettings() {
          try {
            const { getFirestore, doc, setDoc } = await import('https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js');
            const db = getFirestore();
            const payload = {
              content: {
                heroTitle: document.getElementById('hero-title')?.value || null,
                heroSubtitle: document.getElementById('hero-subtitle')?.value || null,
                season: document.getElementById('racing-season')?.value || null,
                copyright: Number(document.getElementById('copyright-year')?.value || new Date().getFullYear()),
              },
              social: {
                facebook: document.getElementById('facebook-url')?.value || null,
                tiktok: document.getElementById('tiktok-handle')?.value || null,
              }
            };
            await setDoc(doc(db, 'config', 'site'), payload, { merge: true });
            showToast('Content saved');
          } catch (e) { showToast('Failed to save content', 'error'); }
        }

        // Logs: functions
        async function refreshLogsUI() {
          try {
            const { getFirestore, collection, getDocs, query, orderBy, limit } = await import('https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js');
            const db = getFirestore();
            const q = query(collection(db, 'client_logs'), orderBy('createdAt','desc'), limit(50));
            const snap = await getDocs(q);
            const tbody = document.getElementById('logs-table-body');
            if (!tbody) return;
            tbody.innerHTML = '';
            if (snap.empty) {
              const tr = document.createElement('tr');
              tr.innerHTML = '<td class="p-2 text-slate-400" colspan="5">No logs</td>';
              tbody.appendChild(tr);
              return;
            }
            snap.forEach(d => {
              const v = d.data() || {};
              const ts = v.createdAt?.seconds ? new Date(v.createdAt.seconds*1000) : null;
              const when = ts ? ts.toLocaleString() : '‚Äî';
              const tr = document.createElement('tr');
              tr.className = 'table-row';
              tr.innerHTML = `
                <td class="p-2 whitespace-nowrap">${when}</td>
                <td class="p-2">${v.level || 'error'}</td>
                <td class="p-2 truncate" title="${(v.message||'').replace(/"/g,'&quot;')}">${v.message || ''}</td>
                <td class="p-2 truncate" title="${(v.page||'').replace(/"/g,'&quot;')}">${v.page || ''}</td>
                <td class="p-2">${v.email || v.uid || '‚Äî'}</td>
              `;
              tbody.appendChild(tr);
            });
          } catch (e) {
            console.error('Failed to load logs:', e);
          }
        }

        // Roles & Invites: functions
        async function refreshInvitesUI() {
          const tbody = document.getElementById('invites-table-body');
          const renderRows = (codes=[]) => {
            if (!tbody) return;
            tbody.innerHTML = '';
            if (!codes.length) {
              const tr = document.createElement('tr');
              tr.innerHTML = '<td class="p-2 text-slate-400" colspan="6">No codes found</td>';
              tbody.appendChild(tr);
              return;
            }
            codes.forEach(c => {
              const tr = document.createElement('tr');
              const used = c.used ? 'used' : 'unused';
              const usedAt = c.usedAt ? new Date((c.usedAt.seconds||c.usedAt._seconds||0)*1000).toLocaleDateString() : '‚Äî';
              const exp = c.expiresAt ? new Date((c.expiresAt.seconds||c.expiresAt._seconds||0)*1000).toLocaleDateString() : '‚Äî';
              tr.className = 'border-b border-slate-700';
              tr.innerHTML = `
                <td class="p-2">${c.id}</td>
                <td class="p-2">${c.role || '‚Äî'}</td>
                <td class="p-2">${used}</td>
                <td class="p-2">${c.usedBy || '‚Äî'}</td>
                <td class="p-2">${usedAt}</td>
                <td class="p-2">${exp}</td>
              `;
              tbody.appendChild(tr);
            });
          };

          // Try callable first (admin/team-member claim)
          try {
            const { getFunctions, httpsCallable } = await import('https://www.gstatic.com/firebasejs/9.22.0/firebase-functions.js');
            const { getAuth } = await import('https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js');
            const auth = getAuth();
            await auth.currentUser?.getIdToken(true);
            const functions = getFunctions(undefined, 'us-central1');
            const getCodes = httpsCallable(functions, 'getInvitationCodes');
            const res = await getCodes({});
            const codes = (res?.data?.codes) || [];
            renderRows(codes);
            return;
          } catch (callableErr) {
            console.warn('Callable getInvitationCodes failed, falling back to Firestore:', callableErr?.message || callableErr);
          }

          // Fallback: read directly from Firestore (rules allow team/admin via users doc role)
          try {
            const { getFirestore, collection, getDocs } = await import('https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js');
            const db = getFirestore();
            const snap = await getDocs(collection(db, 'invitation_codes'));
            const codes = [];
            snap.forEach(d => codes.push({ id: d.id, ...(d.data()||{}) }));
            renderRows(codes);
          } catch (fsErr) {
            console.error('Failed to load invitation codes (fallback):', fsErr);
            if (tbody) {
              tbody.innerHTML = '<tr><td class="p-2 text-red-400" colspan="6">Unable to load invitation codes (insufficient permissions).</td></tr>';
            }
          }
        }

        async function handleCreateCodes() {
          try {
            const roleEl = document.getElementById('new-code-role');
            const countEl = document.getElementById('new-code-count');
            const prefixEl = document.getElementById('new-code-prefix');
            const expEl = document.getElementById('new-code-expires');
            const outEl = document.getElementById('create-codes-result');

            const role = roleEl?.value || 'team-member';
            const count = Math.max(1, parseInt(countEl?.value || '1', 10));
            const prefix = (prefixEl?.value || '').trim() || null;
            const expiresAt = expEl?.value ? new Date(expEl.value).toISOString() : null;

            const { getFunctions, httpsCallable } = await import('https://www.gstatic.com/firebasejs/9.22.0/firebase-functions.js');
            const { getAuth } = await import('https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js');
            const auth = await getAuth();
            await auth.currentUser?.getIdToken(true);
            const functions = getFunctions(undefined, 'us-central1');
            const createCodes = httpsCallable(functions, 'createInvitationCodes');
            const res = await createCodes({ role, count, prefix, expiresAt });
            const created = res?.data?.created || [];
            if (outEl) {
              if (!created.length) outEl.textContent = 'No codes created.';
              else outEl.textContent = 'Created: ' + created.map(x => x.code).join(', ');
            }
            await refreshInvitesUI();
          } catch (e) {
            console.error('Create codes failed:', e);
            const outEl = document.getElementById('create-codes-result');
            if (outEl) outEl.textContent = 'Error creating codes (admin only).';
          }
        }

        async function handleAssignRoles() {
          try {
            const emailsText = (document.getElementById('role-emails')?.value || '').trim();
            const role = (document.getElementById('role-select')?.value || 'team-member');
            if (!emailsText) { showToast('Enter at least one email', 'error'); return; }
            const emails = emailsText.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
            const { getFunctions, httpsCallable } = await import('https://www.gstatic.com/firebasejs/9.22.0/firebase-functions.js');
            const { getAuth } = await import('https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js');
            const auth = getAuth();
            await auth.currentUser?.getIdToken(true);
            const functions = getFunctions(undefined, 'us-central1');
            const setUserRole = httpsCallable(functions, 'setUserRole');
            const res = await setUserRole({ emails, role });
            const data = res?.data || {};
            const resultsEl = document.getElementById('role-results');
            if (resultsEl) {
              const items = (data.results || []).map(r => r.error ? `<li class='text-red-400'>${r.email}: ${r.error}</li>` : `<li class='text-green-400'>${r.email}: ok</li>`).join('');
              resultsEl.innerHTML = `<ul class='list-disc pl-5'>${items || '<li>No results returned</li>'}</ul>`;
            }
            showToast('Roles updated');
          } catch (e) {
            console.error('Assign roles failed:', e);
            showToast('Assign roles failed (admin only).', 'error');
          }
        }

        // TikTok list rendering
        async function refreshTikTokList() {
          try {
            const { getFirestore, collection, getDocs, query, orderBy, limit } = await import('https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js');
            const db = getFirestore();
            const listEl = document.getElementById('tiktok-video-list');
            if (!listEl) return;
            const q = query(collection(db, 'tiktok_videos'), orderBy('createdAt','desc'), limit(50));
            const snap = await getDocs(q);
            listEl.innerHTML = '';
            if (snap.empty) {
              listEl.innerHTML = '<div class="text-slate-400">No TikTok videos yet.</div>';
              return;
            }
            snap.forEach(d => {
              const v = d.data() || {};
              const id = v.videoId || (String(v.url||'').match(/\/(video|photo)\/(\d{6,})/)||[])[2] || d.id;
              const item = document.createElement('div');
              item.className = 'flex items-center justify-between p-2 bg-slate-800/50 border border-slate-700/50 rounded';
              item.innerHTML = `<div class="text-slate-200 text-sm truncate"><a href="${v.url}" target="_blank" class="text-neon-yellow underline">${v.title || id}</a></div><div class="text-xs text-slate-500 ml-2">${id}</div>`;
              listEl.appendChild(item);
            });
          } catch (e) {
            console.warn('Failed to refresh TikTok list', e);
          }
        }

        // Enhanced mobile sidebar toggle
        const sidebarToggle = document.getElementById('sidebar-toggle');
        if (sidebarToggle) {
          sidebarToggle.addEventListener('click', () => {
          const sidebar = document.querySelector('aside');
          const overlay = createMobileSidebarOverlay();
            
            if (sidebar) {
              const isHidden = sidebar.classList.contains('hidden');
              
              if (isHidden) {
                // Show sidebar
                sidebar.classList.remove('hidden');
                sidebar.classList.add('fixed', 'top-0', 'left-0', 'z-50', 'h-full');
                overlay.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
              } else {
                // Hide sidebar
                sidebar.classList.add('hidden');
                sidebar.classList.remove('fixed', 'top-0', 'left-0', 'z-50', 'h-full');
                overlay.classList.add('hidden');
                document.body.style.overflow = '';
              }
            }
          });
        }
        
          // Create mobile sidebar overlay
          function createMobileSidebarOverlay() {
          let overlay = document.getElementById('sidebar-overlay');
          if (!overlay) {
            overlay = document.createElement('div');
            overlay.id = 'sidebar-overlay';
            overlay.className = 'fixed inset-0 bg-black bg-opacity-50 z-40 lg:hidden hidden';
            overlay.addEventListener('click', () => {
              const sidebar = document.querySelector('aside');
              const toggle = document.getElementById('sidebar-toggle');
              if (sidebar && toggle) {
                toggle.click(); // Trigger the toggle to close
              }
            });
            document.body.appendChild(overlay);
          }
          return overlay;
        }
        
        // Gallery approval functionality
        async function loadPendingPhotos() {
          try {
            const { getFirestore, collection, query, where, getDocs } = await import('https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js');
            const app = await ensureDefaultApp();
            const db = getFirestore(app);
            const photosQuery = query(
              collection(db, 'gallery_images'),
              where('approved', '==', false)
            );
            
            const querySnapshot = await getDocs(photosQuery);
            const unapprovedPhotosList = document.getElementById('unapproved-photos-list');
            const photoApprovalCard = document.getElementById('photo-approval-card');
            const galleryPendingCount = document.getElementById('gallery-pending-count');
            
            if (unapprovedPhotosList) {
              unapprovedPhotosList.innerHTML = '';
              
              if (querySnapshot.empty) {
                unapprovedPhotosList.innerHTML = '<p class="text-slate-400 col-span-full text-center">No photos pending approval</p>';
                if (galleryPendingCount) galleryPendingCount.textContent = '0';
              } else {
                if (galleryPendingCount) galleryPendingCount.textContent = querySnapshot.size;
                
                querySnapshot.forEach((docSnapshot) => {
                  const photo = docSnapshot.data();
                  const photoId = docSnapshot.id;
                  
                  const photoCard = document.createElement('div');
                  photoCard.className = 'bg-slate-800/50 backdrop-blur-md border border-slate-700/50 rounded-lg p-4 hover:border-slate-600/50 transition-colors';
                  
                  // Create image element
                  const img = document.createElement('img');
                  img.src = photo.imageUrl;
                  img.className = 'w-full h-48 object-cover rounded-md mb-4 shadow-lg';
                  img.alt = 'Pending photo approval';
                  
                  // Create uploader info
                  const uploaderInfo = document.createElement('p');
                  uploaderInfo.className = 'text-sm text-slate-300 mb-2 font-medium';
                  uploaderInfo.textContent = `Uploaded by: ${photo.uploaderDisplayName || 'Anonymous'}`;
                  
                  // Create date info
                  const dateInfo = document.createElement('p');
                  dateInfo.className = 'text-xs text-slate-400 mb-4';
                  dateInfo.textContent = photo.createdAt ? new Date(photo.createdAt.toDate()).toLocaleDateString() : 'Recently';
                  
                  // Create buttons container
                  const buttonsContainer = document.createElement('div');
                  buttonsContainer.className = 'flex space-x-3';
                  
                  // Create approve button
                  const approveBtn = document.createElement('button');
                  approveBtn.className = 'flex-1 bg-green-600 hover:bg-green-700 text-white px-4 py-2.5 rounded-md text-sm font-semibold transition-colors flex items-center justify-center';
                  approveBtn.innerHTML = '<i class="fas fa-check mr-2"></i>Approve';
                  approveBtn.onclick = () => window.approvePhoto(photoId);
                  
                  // Create reject button
                  const rejectBtn = document.createElement('button');
                  rejectBtn.className = 'flex-1 bg-red-600 hover:bg-red-700 text-white px-4 py-2.5 rounded-md text-sm font-semibold transition-colors flex items-center justify-center';
                  rejectBtn.innerHTML = '<i class="fas fa-times mr-2"></i>Reject';
                  rejectBtn.onclick = () => window.rejectPhoto(photoId);
                  
                  // Append elements
                  buttonsContainer.appendChild(approveBtn);
                  buttonsContainer.appendChild(rejectBtn);
                  
                  photoCard.appendChild(img);
                  photoCard.appendChild(uploaderInfo);
                  photoCard.appendChild(dateInfo);
                  photoCard.appendChild(buttonsContainer);
                  
                  unapprovedPhotosList.appendChild(photoCard);
                });
                
                if (photoApprovalCard) photoApprovalCard.style.display = 'block';
              }
            }
          } catch (error) {
            console.error('Error loading pending photos:', error);
          }
        }
        
        // Wire up buttons and forms in Advanced
        function wireAdvancedActions() {
          const assignBtn = document.getElementById('assign-role-btn');
          if (assignBtn) assignBtn.addEventListener('click', handleAssignRoles);

          const createCodesBtn = document.getElementById('create-codes-btn');
          if (createCodesBtn) createCodesBtn.addEventListener('click', handleCreateCodes);

          const refreshInvBtn = document.getElementById('refresh-invites-btn');
          if (refreshInvBtn) refreshInvBtn.addEventListener('click', refreshInvitesUI);

          const saveTikTokBtn = document.getElementById('save-tiktok-btn');
          if (saveTikTokBtn) saveTikTokBtn.addEventListener('click', async () => {
            try {
              const handle = (document.getElementById('advanced-tiktok-handle')?.value || '').trim();
              const url = (document.getElementById('advanced-tiktok-url')?.value || '').trim();
              const { getFirestore, doc, setDoc } = await import('https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js');
              const db = getFirestore();
              await setDoc(doc(db, 'config', 'tiktok'), { handle, sampleUrl: url, updatedAt: Date.now() }, { merge: true });
              showToast('TikTok settings saved');
            } catch (e) { showToast('Failed to save TikTok settings', 'error'); }
          });

          const previewBtn = document.getElementById('preview-tiktok-btn');
          if (previewBtn) previewBtn.addEventListener('click', () => {
            const url = (document.getElementById('advanced-tiktok-url')?.value || '').trim();
            const m = url.match(/\/(video|photo)\/(\d{6,})/);
            const id = m && m[2];
            const box = document.getElementById('tiktok-inline-preview');
            if (!box) return;
            if (!id) { box.innerHTML = '<div class="text-slate-400">Provide a valid TikTok URL</div>'; return; }
            box.innerHTML = `<iframe src="https://www.tiktok.com/embed/v2/${id}" width="100%" height="600" frameborder="0" allowfullscreen scrolling="no"></iframe>`;
          });

          const addForm = document.getElementById('add-tiktok-video-form');
          if (addForm) addForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
              const url = (document.getElementById('new-tiktok-url')?.value || '').trim();
              const title = (document.getElementById('new-tiktok-title')?.value || '').trim();
              const { getFunctions, httpsCallable } = await import('https://www.gstatic.com/firebasejs/9.22.0/firebase-functions.js');
              const f = getFunctions(undefined, 'us-central1');
              const add = httpsCallable(f, 'addTikTokVideo');
              await add({ url, title, published: true });
              showToast('TikTok video added');
              try { (document.getElementById('new-tiktok-url')).value=''; (document.getElementById('new-tiktok-title')).value=''; } catch {}
              refreshTikTokList();
            } catch (e) { showToast('Failed to add TikTok video', 'error'); }
          });
        }

        // Global functions for photo approval
        window.approvePhoto = async function(photoId) {
          try {
            const role = await getUserRole();
            if (!isModeratorRole(role)) {
              alert('You need to be a team-member or admin to approve photos.');
              return;
            }
            const { getFirestore, doc, updateDoc } = await import('https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js');
            const app = await ensureDefaultApp();
            const db = getFirestore(app);
            
            await updateDoc(doc(db, 'gallery_images', photoId), {
              approved: true,
              approvedAt: new Date(),
              approvedBy: role || 'moderator'
            });
            
            // Reload pending photos
            loadPendingPhotos();
            
            console.log('Photo approved successfully');
          } catch (error) {
            console.error('Error approving photo:', error);
          }
        };
        
        window.rejectPhoto = async function(photoId) {
          if (!confirm('Are you sure you want to reject this photo? This will delete it permanently.')) {
            return;
          }
          
          try {
            const role = await getUserRole();
            if (!isModeratorRole(role)) {
              alert('You need to be a team-member or admin to reject photos.');
              return;
            }
            const { getFirestore, doc, deleteDoc } = await import('https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js');
            const app = await ensureDefaultApp();
            const db = getFirestore(app);
            
            await deleteDoc(doc(db, 'gallery_images', photoId));
            
            // Reload pending photos
            loadPendingPhotos();
            
            console.log('Photo rejected and deleted');
          } catch (error) {
            console.error('Error rejecting photo:', error);
          }
        };
        
        // Toast helper
        function showToast(message, type = 'success') {
          try {
            const toast = document.getElementById('admin-toast');
            if (!toast) return;
            const colors = {
              success: 'bg-green-600 border-green-500',
              error: 'bg-red-600 border-red-500',
              info: 'bg-blue-600 border-blue-500'
            };
            toast.className = `fixed top-4 right-4 text-white px-4 py-3 rounded-lg shadow-lg z-50 border ${colors[type] || colors.success}`;
            toast.textContent = message;
            toast.classList.remove('hidden');
            clearTimeout(window.__adminToastTimer);
            window.__adminToastTimer = setTimeout(() => toast.classList.add('hidden'), 2500);
          } catch (_) {}
        }

        // Simple validators and normalizers for TikTok
        function normalizeHandle(input) {
          if (!input) return '';
          let h = input.trim();
          if (!h) return '';
          if (h.startsWith('https://') || h.startsWith('http://')) {
            // Extract handle from profile URL
            try {
              const u = new URL(h);
              const parts = u.pathname.split('/').filter(Boolean);
              if (parts[0]?.startsWith('@')) h = parts[0];
            } catch (_) {}
          }
          if (!h.startsWith('@')) h = '@' + h;
          return h.replace(/\s+/g, '');
        }

        function isValidTikTokUrl(url) {
          if (!url) return true; // optional
          try {
            const u = new URL(url);
            if (!/tiktok\.com$/i.test(u.hostname) && !/\.tiktok\.com$/i.test(u.hostname)) return false;
            return /^https?:$/i.test(u.protocol);
          } catch (_) {
            return false;
          }
        }

        // TikTok settings: load and save
        async function loadTikTokSettings() {
          try {
            const { getFirestore, doc, getDoc } = await import('https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js');
            const app = await ensureDefaultApp();
            const db = getFirestore(app);
            const ref = doc(db, 'config', 'tiktok');
            const snap = await getDoc(ref);
            if (snap.exists()) {
              const data = snap.data() || {};
              const handleEl = document.getElementById('advanced-tiktok-handle');
              const urlEl = document.getElementById('advanced-tiktok-url');
              if (handleEl) handleEl.value = data.handle || '';
              if (urlEl) urlEl.value = data.sampleUrl || '';
            }
          } catch (e) {
            console.error('Failed to load TikTok settings:', e);
          }
        }
        
        async function generateTestLog() {
          try {
            const { getFirestore, collection, addDoc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js');
            const app = await ensureDefaultApp();
            const db = getFirestore(app);
            await addDoc(collection(db, 'client_logs'), {
              level: 'info',
              message: 'Admin test log entry',
              page: 'admin-console.html',
              createdAt: serverTimestamp(),
              uid: (await import('https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js')).getAuth().currentUser?.uid || null,
            });
            showToast('Test log added');
            await refreshLogsUI();
          } catch(e) { console.error('Failed to generate test log', e); showToast('Failed to generate test log', 'error'); }
        }

        async function saveTikTokSettings() {
          try {
            const role = await getUserRole();
            if (!isModeratorRole(role)) {
              showToast('You need to be a team-member or admin to save TikTok settings.', 'error');
              return;
            }
            const { getFirestore, doc, setDoc } = await import('https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js');
            const app = await ensureDefaultApp();
            const db = getFirestore(app);
            const ref = doc(db, 'config', 'tiktok');
            const handleEl = document.getElementById('advanced-tiktok-handle');
            const urlEl = document.getElementById('advanced-tiktok-url');
            const saveBtn = document.getElementById('save-tiktok-btn');
            let handle = normalizeHandle(handleEl?.value || '');
            const sampleUrl = (urlEl?.value || '').trim();

            if (!handle) {
              showToast('Please enter a TikTok handle.', 'error');
              return;
            }
            if (!isValidTikTokUrl(sampleUrl)) {
              showToast('Sample URL must be a valid TikTok URL.', 'error');
              return;
            }

            if (saveBtn) { saveBtn.disabled = true; saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...'; }
            await setDoc(ref, {
              handle,
              sampleUrl,
              updatedAt: new Date(),
              updatedByRole: role || 'unknown'
            }, { merge: true });
            if (saveBtn) { saveBtn.innerHTML = '<i class="fas fa-check mr-2"></i>Saved'; setTimeout(() => { saveBtn.innerHTML = '<i class=\"fas fa-save mr-2\"></i>Save'; saveBtn.disabled = false; }, 800); }
            showToast('TikTok settings saved.');
          } catch (e) {
            console.error('Failed to save TikTok settings:', e);
            const saveBtn = document.getElementById('save-tiktok-btn');
            if (saveBtn) { saveBtn.innerHTML = '<i class="fas fa-save mr-2"></i>Save'; saveBtn.disabled = false; }
            showToast('Error saving TikTok settings.', 'error');
          }
        }
        
        function previewTikTok() {
          const handleEl = document.getElementById('advanced-tiktok-handle');
          const urlEl = document.getElementById('advanced-tiktok-url');
          const handle = normalizeHandle(handleEl?.value || '');
          const sampleUrl = (urlEl?.value || '').trim();
          const preview = document.getElementById('tiktok-inline-preview');
          if (!preview) return;
          preview.innerHTML = '';
          let target = '';
          if (sampleUrl) {
            if (!isValidTikTokUrl(sampleUrl)) {
              showToast('Sample URL must be a valid TikTok URL.', 'error');
              return;
            }
            target = sampleUrl;
          } else if (handle) {
            target = `https://www.tiktok.com/${handle.replace(/^@/, '')}`;
          }
          if (!target) return;
          // If it's a video URL, try to embed; else show a link
          const vm = target.match(/\/video\/(\d+)/);
          if (vm) {
            const block = document.createElement('blockquote');
            block.className = 'tiktok-embed';
            block.setAttribute('cite', target);
            block.setAttribute('data-video-id', vm[1]);
            const section = document.createElement('section');
            block.appendChild(section);
            preview.appendChild(block);
            const s = document.createElement('script');
            s.src = 'https://www.tiktok.com/embed.js';
            s.async = true;
            preview.appendChild(s);
          } else {
            const a = document.createElement('a');
            a.href = target; a.target = '_blank'; a.className = 'text-red-400 underline'; a.textContent = 'Open TikTok Profile';
            preview.appendChild(a);
          }
        }
        
        // Update timestamps
        function updateTimestamps() {
          const now = new Date();
          const timeString = now.toLocaleTimeString();
          const yearEl = document.getElementById('year');
          if (yearEl) yearEl.textContent = now.getFullYear();
          
          // Update notes timestamp
          const notesTimestamp = document.getElementById('notes-timestamp');
          if (notesTimestamp) notesTimestamp.textContent = timeString;
        }
        
        // Force dashboard reveal after 2 seconds
        setTimeout(showDashboard, 2000);
        
        // Logout functionality
        async function handleLogout() {
          const logoutButton = document.getElementById('logout-button');
          if (logoutButton) {
            logoutButton.disabled = true;
            logoutButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span class="hidden lg:inline ml-1">Signing out...</span>';
          }
          
          try {
            // Import Firebase auth functions
            const { getAuth, signOut } = await import('https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js');
            const auth = getAuth();
            await signOut(auth);
            
            // Redirect to login page
            window.location.href = 'login.html';
          } catch (error) {
            console.error('Logout failed:', error);
            // Even if logout fails, redirect to login
            window.location.href = 'login.html';
          }
        }
        
        function initAdminTopAuth() {
          (async () => {
            try {
              const { getAuth, onAuthStateChanged, signOut } = await import('https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js');
              const auth = getAuth();
              const area = document.getElementById('admin-top-auth');
              const dot = document.getElementById('admin-online-dot');
              const emailEl = document.getElementById('admin-user-email');
              const logoutTop = document.getElementById('logout-button-top');
              if (logoutTop) {
                logoutTop.addEventListener('click', async (e) => {
                  e.preventDefault();
                  try { await signOut(auth); } finally { window.location.href = 'login.html'; }
                });
              }
              onAuthStateChanged(auth, (user) => {
                if (!area) return;
                if (user) {
                  area.classList.remove('hidden');
                  if (dot) dot.style.display = '';
                  if (emailEl) emailEl.textContent = user.email || 'Signed In';
                } else {
                  area.classList.add('hidden');
                }
              });
            } catch(_) {}
          })();
        }

        // Initialize everything when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
          initNavigation();
          updateTimestamps();
          initAdminTopAuth();
          
          // Setup logout button
          const logoutButton = document.getElementById('logout-button');
          if (logoutButton) {
            logoutButton.addEventListener('click', (e) => {
              e.preventDefault();
              if (confirm('Are you sure you want to sign out?')) {
                handleLogout();
              }
            });
          }
          
          // Ensure admin/public-fan role claims are set before loading data
          (async () => {
            try {
              const { getFunctions, httpsCallable } = await import('https://www.gstatic.com/firebasejs/9.22.0/firebase-functions.js');
              try { await httpsCallable(getFunctions(), 'ensureDefaultRole')({}); } catch(_) {}
              const { getAuth } = await import('https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js');
              try { await getAuth().currentUser?.getIdToken(true); } catch(_) {}
            } catch (_) {}

          // Load pending photos on startup (after claims ensured)
            loadPendingPhotos();
            // Preload races table so editor appears when opening Race Management
            try { loadRaceTable(); } catch(_) {}
            
            // Setup navigation click handlers
            const galleryApprovalLink = document.querySelector('a[href="#gallery-approvals"]');
            if (galleryApprovalLink) {
              galleryApprovalLink.addEventListener('click', () => {
                loadPendingPhotos();
              });
            }
            
            // Update timestamps every minute
            setInterval(updateTimestamps, 60000);
            
          // Initialize all button functionality
          initializeAdminButtons();
          loadRealFirebaseData();
          // Load Advanced > TikTok settings
          loadTikTokSettings();

          // Load & render TikTok library
          try {
            await loadTikTokLibrary();
          } catch(_) {}
          
          console.log('üèéÔ∏è Admin Command Center initialized successfully!');
          })();
        });
        
        async function loadTikTokLibrary() {
          try {
            const role = await getUserRole();
            const canEdit = isModeratorRole(role);
            const { getFirestore, collection, getDocs, query, orderBy, addDoc, deleteDoc, doc } = await import('https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js');
            const app = await ensureDefaultApp();
            const db = getFirestore(app);
            const listEl = document.getElementById('tiktok-video-list');
            if (!listEl) return;
            listEl.innerHTML = '';
            const q = query(collection(db, 'tiktok_videos'), orderBy('createdAt', 'desc'));
            const snap = await getDocs(q);
            if (snap.empty) {
              listEl.innerHTML = '<div class="text-slate-400 text-sm">No videos in library yet.</div>';
              return;
            }
            snap.forEach((d) => {
              const v = d.data() || {};
              const row = document.createElement('div');
              row.className = 'flex items-center justify-between bg-slate-800/50 border border-slate-700 rounded p-2';
              const title = v.title || v.sampleUrl || v.url || d.id;
              row.innerHTML = `<div class="truncate max-w-[70%] text-slate-200">${title}</div>`;
              if (canEdit) {
                const btn = document.createElement('button');
                btn.className = 'bg-red-600 hover:bg-red-700 text-white px-2 py-1 rounded text-xs';
                btn.textContent = 'Delete';
                btn.addEventListener('click', async () => {
                  if (!confirm('Delete this TikTok video?')) return;
                  try {
                    await deleteDoc(doc(db, 'tiktok_videos', d.id));
                    showToast('Deleted');
                    await loadTikTokLibrary();
                  } catch (_) { showToast('Delete failed', 'error'); }
                });
                row.appendChild(btn);
              }
              listEl.appendChild(row);
            });
          } catch(_) {}
        }

        async function addTikTokVideo() {
          try {
            const role = await getUserRole();
            if (!isModeratorRole(role)) { showToast('Team-member or admin only', 'error'); return; }
            const { getFirestore, collection, addDoc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js');
            const app = await ensureDefaultApp();
            const db = getFirestore(app);
            const urlEl = document.getElementById('new-tiktok-url');
            const titleEl = document.getElementById('new-tiktok-title');
            const url = (urlEl?.value || '').trim();
            const title = (titleEl?.value || '').trim();
            if (!isValidTikTokUrl(url)) { showToast('Enter a valid TikTok URL', 'error'); return; }
            await addDoc(collection(db, 'tiktok_videos'), { sampleUrl: url, title: title || null, createdAt: serverTimestamp() });
            urlEl.value = ''; titleEl.value = '';
            showToast('Added');
            await loadTikTokLibrary();
          } catch(_) { showToast('Add failed', 'error'); }
        }

        // Load real Firebase data for all stats
        async function loadRealFirebaseData() {
          try {
            const { getFirestore, collection, getDocs, query, where } = await import('https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js');
            const app = await ensureDefaultApp();
            const db = getFirestore(app);
            
            // Load gallery photos count
            const approvedPhotosQuery = query(collection(db, 'gallery_images'), where('approved', '==', true));
            const approvedPhotos = await getDocs(approvedPhotosQuery);
            const totalPhotosEl = document.getElementById('total-photos');
            if (totalPhotosEl) {
              totalPhotosEl.textContent = approvedPhotos.size;
            }
            
            // Load pending approvals count
            const pendingPhotosQuery = query(collection(db, 'gallery_images'), where('approved', '==', false));
            const pendingPhotos = await getDocs(pendingPhotosQuery);
            const pendingApprovalsEl = document.getElementById('pending-approvals');
            const galleryPendingEl = document.getElementById('gallery-pending-count');
            if (pendingApprovalsEl) {
              pendingApprovalsEl.textContent = pendingPhotos.size;
            }
            if (galleryPendingEl) {
              galleryPendingEl.textContent = pendingPhotos.size;
            }
            
            // Update pending badge in gallery section
            const galleryPendingBadge = document.querySelector('.status-pending');
            if (galleryPendingBadge) {
              galleryPendingBadge.textContent = `${pendingPhotos.size} Pending`;
            }
            
          } catch (error) {
            console.error('Error loading Firebase data:', error);
          }
        }
        
        // Initialize all admin button functionality
        function initializeAdminButtons() {
          // Add Race Button
          const addRaceBtn = document.getElementById('add-race-btn');
          if (addRaceBtn) {
            addRaceBtn.addEventListener('click', showAddRaceModal);
          }
          
          // Quick Action Buttons
          const approveAllBtn = document.getElementById('approve-all-btn');
          if (approveAllBtn) {
            approveAllBtn.addEventListener('click', approveAllPhotos);
          }
          
          const refreshBtn = document.getElementById('refresh-data-btn');
          if (refreshBtn) {
            refreshBtn.addEventListener('click', refreshAllData);
          }
          
          const exportBtn = document.getElementById('export-data-btn');
          if (exportBtn) {
            exportBtn.addEventListener('click', exportData);
          }
          
          const cleanupBtn = document.getElementById('cleanup-btn');
          if (cleanupBtn) {
            cleanupBtn.addEventListener('click', performCleanup);
          }
          
          // Advanced > TikTok buttons
          const saveTikTokBtn = document.getElementById('save-tiktok-btn');
          if (saveTikTokBtn) {
            saveTikTokBtn.addEventListener('click', (e) => {
              e.preventDefault();
              saveTikTokSettings();
            });
          }
          const previewTikTokBtn = document.getElementById('preview-tiktok-btn');
          if (previewTikTokBtn) {
            previewTikTokBtn.addEventListener('click', (e) => {
              e.preventDefault();
              previewTikTok();
            });
          }

          // TikTok Library form
          const addTikTokForm = document.getElementById('add-tiktok-video-form');
          if (addTikTokForm) {
            addTikTokForm.addEventListener('submit', async (e) => {
              e.preventDefault();
              await addTikTokVideo();
            });
          }

          // Error Logs: generate test log removed per request

          // Logs
          const refreshLogsBtn = document.getElementById('refresh-logs-btn');
          if (refreshLogsBtn) refreshLogsBtn.addEventListener('click', (e)=>{ e.preventDefault(); refreshLogsUI(); });

          // Roles & Invites events
          const refreshInvBtn = document.getElementById('refresh-invites-btn');
          if (refreshInvBtn) refreshInvBtn.addEventListener('click', (e)=>{ e.preventDefault(); refreshInvitesUI(); });
          const createCodesBtn = document.getElementById('create-codes-btn');
          if (createCodesBtn) createCodesBtn.addEventListener('click', (e)=>{ e.preventDefault(); handleCreateCodes(); });
          const assignRoleBtn = document.getElementById('assign-role-btn');
          if (assignRoleBtn) assignRoleBtn.addEventListener('click', (e)=>{ e.preventDefault(); handleAssignRoles(); });

// Normalize logout buttons styling/labels
          const lb = document.getElementById('logout-button');
          const lbt = document.getElementById('logout-button-top');
          const mlb = document.getElementById('mobile-logout-button');
          const clsDanger = 'bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors flex items-center';
          const clsGhost = 'bg-slate-800/50 hover:bg-slate-700/50 border border-slate-600/50 text-white px-3 py-1 rounded text-sm transition-colors flex items-center';
          const htmlLabel = '<i class="fas fa-sign-out-alt mr-2"></i>Sign Out';
          if (lb) { lb.className = clsDanger; lb.innerHTML = htmlLabel; }
          if (lbt) { lbt.className = clsGhost; lbt.innerHTML = htmlLabel; }
          if (mlb) { mlb.className = clsDanger + ' justify-center'; mlb.innerHTML = htmlLabel; }

          // Q&A and Videos section buttons
          const rq = document.getElementById('refresh-qna-btn');
          if (rq) rq.addEventListener('click', (e)=>{ e.preventDefault(); loadQnaPending(); });
          const rv = document.getElementById('refresh-videos-btn');
          if (rv) rv.addEventListener('click', (e)=>{ e.preventDefault(); loadVideoPending(); });
          const svs = document.getElementById('save-video-settings');
          if (svs) svs.addEventListener('click', (e)=>{ e.preventDefault(); saveVideoSettings(); });
        }
        
        // Add Race Modal/Form functionality
        function showAddRaceModal() {
          // Ensure Race section is visible
          try { showRace(); } catch(_) {}
          const raceSection = document.getElementById('race-section');
          if (raceSection) {
            raceSection.scrollIntoView({ behavior: 'smooth' });
          }
          
          // Create add race form if it doesn't exist
          const tableBody = document.getElementById('races-table-body');
          if (tableBody && !document.getElementById('add-race-form')) {
            const formRow = document.createElement('div');
            formRow.id = 'add-race-form';
            formRow.className = 'table-row p-4 bg-blue-600/10 border border-blue-500/30 rounded-lg mb-4';
            formRow.innerHTML = `
              <div class="grid grid-cols-4 gap-4">
                <input type="date" id="race-date" class="modern-input p-2 text-white" required>
                <input type="text" id="race-name" placeholder="Race Name" class="modern-input p-2 text-white" required>
                <select id="race-status" class="modern-input p-2 text-white">
                  <option value="upcoming">Upcoming</option>
                  <option value="active">Active</option>
                  <option value="completed">Completed</option>
                </select>
                <div class="flex space-x-2">
                  <button onclick="saveNewRace()" class="success-btn px-4 py-2 rounded text-sm">
                    <i class="fas fa-save mr-1"></i>Save
                  </button>
                  <button onclick="cancelAddRace()" class="danger-btn px-4 py-2 rounded text-sm">
                    <i class="fas fa-times mr-1"></i>Cancel
                  </button>
                </div>
              </div>
            `;
            tableBody.insertBefore(formRow, tableBody.firstChild);
          }
        }
        
        // Save new race
        window.saveNewRace = async function() {
          const date = document.getElementById('race-date').value;
          const name = document.getElementById('race-name').value;
          const status = document.getElementById('race-status').value;
          
          if (!date || !name) {
            alert('Please fill in all required fields');
            return;
          }
          
          try {
            const { getFirestore, collection, addDoc } = await import('https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js');
            const app = await ensureDefaultApp();
            const db = getFirestore(app);
            
            await addDoc(collection(db, 'races'), {
              date: new Date(date),
              name: name,
              status: status,
              createdAt: new Date(),
              createdBy: 'admin'
            });
            
            alert('Race added successfully!');
            cancelAddRace();
            loadRealFirebaseData();
          } catch (error) {
            console.error('Error adding race:', error);
            alert('Error adding race. Please try again.');
          }
        };
        
        // Cancel add race
        window.cancelAddRace = function() {
          const form = document.getElementById('add-race-form');
          if (form) {
            form.remove();
          }
        };
        
        // Approve all photos
        async function approveAllPhotos() {
          if (!confirm('Are you sure you want to approve ALL pending photos?')) {
            return;
          }
          
          const button = document.getElementById('approve-all-btn');
          button.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Approving...';
          button.disabled = true;
          
          try {
            const role = await getUserRole();
            if (!isModeratorRole(role)) {
              alert('You need to be a team-member or admin to approve photos.');
              button.innerHTML = '<i class="fas fa-check mr-1"></i>Approve All';
              button.disabled = false;
              return;
            }
            const { getFirestore, collection, query, where, getDocs, doc, updateDoc } = await import('https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js');
            const app = await ensureDefaultApp();
            const db = getFirestore(app);
            
            const pendingQuery = query(collection(db, 'gallery_images'), where('approved', '==', false));
            const pendingPhotos = await getDocs(pendingQuery);
            
            const updatePromises = [];
            pendingPhotos.forEach((photoDoc) => {
              updatePromises.push(
                updateDoc(doc(db, 'gallery_images', photoDoc.id), {
                  approved: true,
                  approvedAt: new Date(),
                  approvedBy: 'admin-bulk'
                })
              );
            });
            
            await Promise.all(updatePromises);
            
            alert(`Successfully approved ${pendingPhotos.size} photos!`);
            loadPendingPhotos();
            loadRealFirebaseData();
            
          } catch (error) {
            console.error('Error approving all photos:', error);
            alert('Error approving photos. Please try again.');
          } finally {
            button.innerHTML = '<i class="fas fa-check mr-1"></i>Approve All';
            button.disabled = false;
          }
        }
        
        // Refresh all data
        function refreshAllData() {
          const button = document.getElementById('refresh-data-btn');
          button.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Refreshing...';
          button.disabled = true;
          
          Promise.all([
            loadRealFirebaseData(),
            loadPendingPhotos()
          ]).then(() => {
            button.innerHTML = '<i class="fas fa-sync mr-1"></i>Refresh Data';
            button.disabled = false;
            
            // Show success notification
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            notification.innerHTML = '<i class="fas fa-check mr-2"></i>Data refreshed successfully!';
            document.body.appendChild(notification);
            
            setTimeout(() => {
              notification.remove();
            }, 3000);
          }).catch(error => {
            console.error('Error refreshing data:', error);
            button.innerHTML = '<i class="fas fa-sync mr-1"></i>Refresh Data';
            button.disabled = false;
            alert('Error refreshing data. Please try again.');
          });
        }
        
        // Export data functionality
        function exportData() {
          const button = document.getElementById('export-data-btn');
          button.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Exporting...';
          button.disabled = true;
          
          // Simulate export process
          setTimeout(() => {
            const exportData = {
              timestamp: new Date().toISOString(),
              totalPhotos: document.getElementById('total-photos').textContent,
              pendingApprovals: document.getElementById('pending-approvals').textContent,
              totalRaces: document.getElementById('total-races').textContent,
              activeUsers: document.getElementById('active-users').textContent
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `redsracing-admin-data-${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            button.innerHTML = '<i class="fas fa-download mr-1"></i>Export';
            button.disabled = false;
            
            alert('Data exported successfully!');
          }, 2000);
        }
        
        // Cleanup functionality
        function performCleanup() {
          if (!confirm('This will clean up old rejected photos and temporary data. Continue?')) {
            return;
          }
          
          const button = document.getElementById('cleanup-btn');
          button.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Cleaning...';
          button.disabled = true;
          
          // Simulate cleanup process
          setTimeout(() => {
            button.innerHTML = '<i class="fas fa-trash mr-1"></i>Cleanup';
            button.disabled = false;
            
            alert('Cleanup completed successfully!');
            loadRealFirebaseData();
          }, 3000);
        }
        
        // Enhanced error handling
        window.addEventListener('error', (e) => {
          console.warn('Admin Console Warning:', e.message);
        });
        
        window.addEventListener('unhandledrejection', (e) => {
          console.warn('Admin Console Promise Rejection:', e.reason);
        });
        
      })();
    </script>
  </body>
</html>
