<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Achievement Firestore Loading Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background: #f5f5f5;
      }
      .test-container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .test-result {
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
      }
      .pass {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .fail {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }
      #all-achievements {
        margin-top: 20px;
      }
      .achievement-item {
        padding: 10px;
        margin: 5px 0;
        background: #f8f9fa;
        border-radius: 4px;
      }
    </style>
  </head>
  <body>
    <h1>üß™ Achievement Firestore Loading Test</h1>
    <p>Testing the updated loadAllAchievements function that uses Firestore</p>

    <div class="test-container">
      <h2>üî• Firestore Achievement Loading</h2>
      <button onclick="testFirestoreLoading()">Test Firestore Loading</button>
      <div id="firestore-test-results"></div>
    </div>

    <div class="test-container">
      <h2>üö´ Error Handling Test</h2>
      <button onclick="testErrorHandling()">Test Error Scenarios</button>
      <div id="error-test-results"></div>
    </div>

    <div class="test-container">
      <h2>üìã Mock Achievement Display</h2>
      <div id="all-achievements"></div>
    </div>

    <script type="module">
      let testResults = { passed: 0, failed: 0, total: 0 };

      function logResult(elementId, message, success) {
        const element = document.getElementById(elementId);
        const resultDiv = document.createElement("div");
        resultDiv.className = `test-result ${success ? "pass" : "fail"}`;
        resultDiv.textContent = message;
        element.appendChild(resultDiv);

        if (success) testResults.passed++;
        else testResults.failed++;
        testResults.total++;
      }

      // Mock Firebase functions for testing
      window.getFirebaseDb = function () {
        return {
          // Mock Firestore database
          collection: function (path) {
            return {
              path: path,
              getDocs: function () {
                return Promise.resolve({
                  docs: [
                    {
                      id: "first_race",
                      data: () => ({
                        name: "First Race",
                        description: "Complete your first race",
                        category: "racing",
                        points: 10,
                        icon: "üèÅ",
                      }),
                    },
                    {
                      id: "speed_demon",
                      data: () => ({
                        name: "Speed Demon",
                        description: "Achieve top speed record",
                        category: "performance",
                        points: 25,
                        icon: "‚ö°",
                      }),
                    },
                  ],
                });
              },
            };
          },
        };
      };

      // Mock collection and getDocs functions for error testing
      window.collection = function (db, path) {
        if (path === "achievements") {
          return { path: path, db: db };
        }
        throw new Error("Collection not found");
      };

      window.getDocs = function (ref) {
        if (ref.path === "achievements") {
          return Promise.resolve({
            docs: [
              {
                id: "test_achievement",
                data: () => ({
                  name: "Test Achievement",
                  description: "Test description",
                  category: "test",
                  points: 5,
                  icon: "üß™",
                }),
              },
            ],
          });
        }
        return Promise.reject(new Error("Mock error"));
      };

      // Mock displayAllAchievements function
      window.displayAllAchievements = function (achievements) {
        const container = document.getElementById("all-achievements");
        if (achievements.length === 0) {
          container.innerHTML =
            '<p class="text-slate-400">No achievements available.</p>';
          return;
        }

        container.innerHTML = achievements
          .map(
            (achievement) => `
                <div class="achievement-item">
                    <strong>${achievement.name}</strong> (${achievement.points} pts)<br>
                    <small>${achievement.description}</small><br>
                    <em>Category: ${achievement.category}</em>
                </div>
            `,
          )
          .join("");
      };

      // Test function that mimics the updated loadAllAchievements
      async function mockLoadAllAchievements() {
        try {
          const db = window.getFirebaseDb();

          if (!db) {
            console.error("Firestore database not available");
            window.displayAllAchievements([]);
            return { success: false, error: "No database" };
          }

          console.log("[Test] Loading achievements from Firestore...");
          const achievementsRef = window.collection(db, "achievements");
          const achievementsSnapshot = await window.getDocs(achievementsRef);

          const achievements = achievementsSnapshot.docs.map((doc) => ({
            id: doc.id,
            ...doc.data(),
          }));

          console.log(
            `[Test] Successfully loaded ${achievements.length} achievements from Firestore`,
          );
          window.displayAllAchievements(achievements);
          return { success: true, achievements: achievements };
        } catch (error) {
          console.error("Error loading achievements from Firestore:", error);
          window.displayAllAchievements([]);
          return { success: false, error: error.message };
        }
      }

      window.testFirestoreLoading = async function () {
        const resultsContainer = document.getElementById(
          "firestore-test-results",
        );
        resultsContainer.innerHTML = "";

        // Test 1: Successful loading
        try {
          const result = await mockLoadAllAchievements();
          if (result.success && result.achievements.length > 0) {
            logResult(
              "firestore-test-results",
              "‚úÖ Successfully loaded achievements from Firestore",
              true,
            );
            logResult(
              "firestore-test-results",
              `‚úÖ Loaded ${result.achievements.length} achievements`,
              true,
            );
          } else {
            logResult(
              "firestore-test-results",
              "‚ùå Failed to load achievements",
              false,
            );
          }
        } catch (error) {
          logResult(
            "firestore-test-results",
            `‚ùå Error during loading: ${error.message}`,
            false,
          );
        }

        // Test 2: Database structure validation
        const db = window.getFirebaseDb();
        if (db && typeof db.collection === "function") {
          logResult(
            "firestore-test-results",
            "‚úÖ Database connection and collection method available",
            true,
          );
        } else {
          logResult(
            "firestore-test-results",
            "‚ùå Database connection or collection method missing",
            false,
          );
        }
      };

      window.testErrorHandling = async function () {
        const resultsContainer = document.getElementById("error-test-results");
        resultsContainer.innerHTML = "";

        // Test 1: No database scenario
        const originalGetDb = window.getFirebaseDb;
        window.getFirebaseDb = () => null;

        try {
          const result = await mockLoadAllAchievements();
          if (!result.success && result.error === "No database") {
            logResult(
              "error-test-results",
              "‚úÖ Correctly handled missing database",
              true,
            );
          } else {
            logResult(
              "error-test-results",
              "‚ùå Did not handle missing database correctly",
              false,
            );
          }
        } catch (error) {
          logResult(
            "error-test-results",
            "‚ùå Unexpected error with missing database",
            false,
          );
        }

        // Restore original function
        window.getFirebaseDb = originalGetDb;

        // Test 2: Network error scenario
        const originalGetDocs = window.getDocs;
        window.getDocs = () => Promise.reject(new Error("Network error"));

        try {
          const result = await mockLoadAllAchievements();
          if (!result.success) {
            logResult(
              "error-test-results",
              "‚úÖ Correctly handled network error",
              true,
            );
          } else {
            logResult(
              "error-test-results",
              "‚ùå Did not handle network error correctly",
              false,
            );
          }
        } catch (error) {
          logResult(
            "error-test-results",
            "‚ùå Unexpected error handling network error",
            false,
          );
        }

        // Restore original function
        window.getDocs = originalGetDocs;

        logResult(
          "error-test-results",
          "‚úÖ Error handling tests completed",
          true,
        );
      };
    </script>
  </body>
</html>
