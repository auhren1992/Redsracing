<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login Tests - RedsRacing #8</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .test-container { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .test-result { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .pass { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .fail { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        input, button { padding: 8px; margin: 5px; border: 1px solid #ccc; border-radius: 4px; }
        button { background: #007bff; color: white; cursor: pointer; }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
    </style>
</head>
<body>
    <h1>RedsRacing Login System Tests</h1>
    
    <div class="test-container">
        <h2>Validation Tests</h2>
        <div id="validation-results"></div>
        <button onclick="runValidationTests()">Run Validation Tests</button>
    </div>

    <div class="test-container">
        <h2>Manual Login Test</h2>
        <p>Test the login functionality with sample credentials:</p>
        <div>
            <input type="email" id="test-email" placeholder="Email" value="test@example.com">
            <input type="password" id="test-password" placeholder="Password" value="test123">
            <button onclick="testLogin()" id="test-login-btn">Test Login</button>
        </div>
        <div id="login-results"></div>
    </div>

    <div class="test-container">
        <h2>Error Handling Tests</h2>
        <div id="error-results"></div>
        <button onclick="runErrorTests()">Run Error Handling Tests</button>
    </div>

    <script type="module">
        // Import the Firebase functions for testing
        import { getFirebaseConfig } from '../assets/js/firebase-config.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        let auth;

        // Initialize Firebase for testing
        async function initFirebaseForTest() {
            try {
                const firebaseConfig = await getFirebaseConfig();
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                return true;
            } catch (error) {
                console.error('Firebase initialization failed:', error);
                return false;
            }
        }

        // Validation functions (copied from login.html for testing)
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        function validateLoginForm(email, password) {
            const errors = [];
            
            if (!email || !password) {
                errors.push('Missing required fields');
            }
            
            if (email && !isValidEmail(email)) {
                errors.push('Invalid email format');
            }
            
            if (password && password.length < 6) {
                errors.push('Password too short (minimum 6 characters)');
            }
            
            return errors;
        }

        // Test validation logic
        window.runValidationTests = function() {
            const results = document.getElementById('validation-results');
            results.innerHTML = '';

            const testCases = [
                { email: '', password: '', expected: ['Missing required fields'] },
                { email: 'invalid-email', password: 'password123', expected: ['Invalid email format'] },
                { email: 'test@example.com', password: '123', expected: ['Password too short (minimum 6 characters)'] },
                { email: 'test@example.com', password: 'validpassword', expected: [] },
                { email: '', password: 'validpassword', expected: ['Missing required fields'] },
                { email: 'test@example.com', password: '', expected: ['Missing required fields'] }
            ];

            let passCount = 0;
            testCases.forEach((testCase, index) => {
                const errors = validateLoginForm(testCase.email, testCase.password);
                const passed = JSON.stringify(errors) === JSON.stringify(testCase.expected);
                
                const resultDiv = document.createElement('div');
                resultDiv.className = `test-result ${passed ? 'pass' : 'fail'}`;
                resultDiv.innerHTML = `
                    Test ${index + 1}: ${passed ? 'PASS' : 'FAIL'}<br>
                    Input: email="${testCase.email}", password="${testCase.password}"<br>
                    Expected: ${JSON.stringify(testCase.expected)}<br>
                    Actual: ${JSON.stringify(errors)}
                `;
                results.appendChild(resultDiv);

                if (passed) passCount++;
            });

            const summaryDiv = document.createElement('div');
            summaryDiv.className = `test-result ${passCount === testCases.length ? 'pass' : 'fail'}`;
            summaryDiv.innerHTML = `Validation Tests: ${passCount}/${testCases.length} passed`;
            results.appendChild(summaryDiv);
        };

        // Test error handling
        window.runErrorTests = function() {
            const results = document.getElementById('error-results');
            results.innerHTML = '';

            const errorTests = [
                { code: 'auth/user-not-found', expected: 'No account found with this email address' },
                { code: 'auth/wrong-password', expected: 'Incorrect password' },
                { code: 'auth/invalid-email', expected: 'Please enter a valid email address' },
                { code: 'auth/too-many-requests', expected: 'Too many failed login attempts' },
                { code: 'auth/network-request-failed', expected: 'Network error' }
            ];

            errorTests.forEach((test, index) => {
                const mockError = { code: test.code, message: `Original error: ${test.code}` };
                const friendlyMessage = getFriendlyErrorMessage(mockError);
                const passed = friendlyMessage.includes(test.expected);

                const resultDiv = document.createElement('div');
                resultDiv.className = `test-result ${passed ? 'pass' : 'fail'}`;
                resultDiv.innerHTML = `
                    Error Test ${index + 1}: ${passed ? 'PASS' : 'FAIL'}<br>
                    Error Code: ${test.code}<br>
                    Expected to contain: "${test.expected}"<br>
                    Actual: "${friendlyMessage}"
                `;
                results.appendChild(resultDiv);
            });
        };

        // Test login functionality (with mock credentials)
        window.testLogin = async function() {
            const email = document.getElementById('test-email').value;
            const password = document.getElementById('test-password').value;
            const results = document.getElementById('login-results');
            const btn = document.getElementById('test-login-btn');

            results.innerHTML = '';
            btn.disabled = true;
            btn.textContent = 'Testing...';

            try {
                // First validate inputs
                const validationErrors = validateLoginForm(email, password);
                if (validationErrors.length > 0) {
                    const resultDiv = document.createElement('div');
                    resultDiv.className = 'test-result fail';
                    resultDiv.innerHTML = `Validation Failed: ${validationErrors.join(', ')}`;
                    results.appendChild(resultDiv);
                    return;
                }

                // Check if Firebase is initialized
                if (!auth) {
                    const initialized = await initFirebaseForTest();
                    if (!initialized) {
                        const resultDiv = document.createElement('div');
                        resultDiv.className = 'test-result fail';
                        resultDiv.innerHTML = 'Firebase initialization failed';
                        results.appendChild(resultDiv);
                        return;
                    }
                }

                // Attempt sign in (this will likely fail with test credentials)
                await signInWithEmailAndPassword(auth, email, password);
                
                const resultDiv = document.createElement('div');
                resultDiv.className = 'test-result pass';
                resultDiv.innerHTML = 'Login successful! (Unexpected with test credentials)';
                results.appendChild(resultDiv);

            } catch (error) {
                // This is expected behavior with test credentials
                const friendlyMessage = getFriendlyErrorMessage(error);
                const resultDiv = document.createElement('div');
                resultDiv.className = 'test-result info';
                resultDiv.innerHTML = `
                    Expected Authentication Error (Normal):<br>
                    Firebase Error: ${error.code}<br>
                    User-Friendly Message: ${friendlyMessage}
                `;
                results.appendChild(resultDiv);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Test Login';
            }
        };

        // Helper function for friendly error messages (copied from login.html)
        function getFriendlyErrorMessage(error) {
            switch (error.code) {
                case 'auth/user-not-found':
                    return 'No account found with this email address. Please check your email or sign up for a new account.';
                case 'auth/wrong-password':
                    return 'Incorrect password. Please try again or use "Forgot password?" to reset it.';
                case 'auth/invalid-email':
                    return 'Please enter a valid email address.';
                case 'auth/user-disabled':
                    return 'This account has been disabled. Please contact support for assistance.';
                case 'auth/too-many-requests':
                    return 'Too many failed login attempts. Please wait a moment and try again.';
                case 'auth/network-request-failed':
                    return 'Network error. Please check your internet connection and try again.';
                case 'auth/invalid-credential':
                    return 'Invalid email or password. Please check your credentials and try again.';
                default:
                    return error.message || 'An unexpected error occurred. Please try again.';
            }
        }

        // Auto-run validation tests when page loads
        document.addEventListener('DOMContentLoaded', function() {
            runValidationTests();
        });
    </script>
</body>
</html>