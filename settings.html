<!doctype html>
<html lang="en" class="scroll-smooth">
  <head>
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8879853783053353"
         crossorigin="anonymous"></script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Settings - RedsRacing #8</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico" />
    <link rel="icon" type="image/svg+xml" href="favicon.svg" />
    <link rel="apple-touch-icon" href="apple-touch-icon.png" />
    <link rel="manifest" href="site.webmanifest" />
    <link rel="stylesheet" href="styles/tailwind.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Racing+Sans+One&family=Inter:wght@400;700;900&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styles/main.css" />
    <link rel="stylesheet" href="styles/input-fix.css" />
    <link rel="stylesheet" href="styles/modern-nav.css" />
    <link rel="stylesheet" href="styles/mobile-menu-tabs.css" />
    
    <style>
      /* Modern Settings Page Styles */
      body {
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
        min-height: 100vh;
        transition: background 0.3s ease;
      }
      
      /* Light Theme */
      html:not(.dark) body {
        background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 50%, #f1f5f9 100%);
      }
      
      .settings-hero {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(251, 191, 36, 0.1));
        border-bottom: 1px solid rgba(148, 163, 184, 0.1);
        padding: 3rem 1.5rem 2rem;
        text-align: center;
        margin-top: 70px;
        transition: background 0.3s ease, border-color 0.3s ease;
      }
      
      html:not(.dark) .settings-hero {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(251, 191, 36, 0.15));
        border-bottom: 1px solid rgba(148, 163, 184, 0.2);
      }
      
      .settings-hero h1 {
        font-family: 'Racing Sans One', sans-serif;
        font-size: clamp(2rem, 5vw, 3rem);
        background: linear-gradient(45deg, #3b82f6, #fbbf24);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 0.5rem;
      }
      
      .user-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        background: rgba(59, 130, 246, 0.2);
        border: 1px solid rgba(59, 130, 246, 0.3);
        padding: 0.5rem 1rem;
        border-radius: 9999px;
        color: #60a5fa;
        font-size: 0.875rem;
        font-weight: 600;
      }
      
      .settings-content {
        max-width: 900px;
        margin: 0 auto;
        padding: 2rem 1.5rem;
      }
      
      .settings-card {
        background: rgba(30, 41, 59, 0.4);
        backdrop-filter: blur(16px);
        border: 1px solid rgba(148, 163, 184, 0.1);
        border-radius: 1rem;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 4px 24px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
      }
      
      html:not(.dark) .settings-card {
        background: rgba(255, 255, 255, 0.8);
        border: 1px solid rgba(148, 163, 184, 0.2);
        box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08);
      }
      
      .settings-card:hover {
        transform: translateY(-2px);
        border-color: rgba(251, 191, 36, 0.3);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      }
      
      .card-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid rgba(148, 163, 184, 0.1);
      }
      
      .card-icon {
        width: 2.5rem;
        height: 2.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(251, 191, 36, 0.2));
        border-radius: 0.5rem;
        color: #fbbf24;
        font-size: 1.25rem;
      }
      
      .card-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: white;
        transition: color 0.3s ease;
      }
      
      html:not(.dark) .card-title {
        color: #1e293b;
      }
      
      .setting-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 0;
        border-bottom: 1px solid rgba(148, 163, 184, 0.05);
      }
      
      .setting-row:last-child {
        border-bottom: none;
      }
      
      .setting-info {
        flex: 1;
      }
      
      .setting-label {
        color: white;
        font-weight: 600;
        font-size: 1rem;
        margin-bottom: 0.25rem;
        transition: color 0.3s ease;
      }
      
      html:not(.dark) .setting-label {
        color: #1e293b;
      }
      
      .setting-description {
        color: rgba(148, 163, 184, 0.7);
        font-size: 0.875rem;
        transition: color 0.3s ease;
      }
      
      html:not(.dark) .setting-description {
        color: rgba(51, 65, 85, 0.7);
      }
      
      /* Toggle Switch */
      .toggle-switch {
        position: relative;
        width: 52px;
        height: 28px;
        flex-shrink: 0;
      }
      
      .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }
      
      .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(100, 116, 139, 0.3);
        transition: 0.3s;
        border-radius: 28px;
        border: 2px solid rgba(148, 163, 184, 0.2);
      }
      
      .toggle-slider:before {
        position: absolute;
        content: "";
        height: 20px;
        width: 20px;
        left: 2px;
        bottom: 2px;
        background-color: white;
        transition: 0.3s;
        border-radius: 50%;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }
      
      input:checked + .toggle-slider {
        background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        border-color: #3b82f6;
      }
      
      input:checked + .toggle-slider:before {
        transform: translateX(24px);
      }
      
      /* Select Dropdown */
      .settings-select {
        background: rgba(15, 23, 42, 0.6);
        border: 1px solid rgba(148, 163, 184, 0.2);
        border-radius: 0.5rem;
        padding: 0.625rem 2.5rem 0.625rem 0.875rem;
        color: white;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.3s ease;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23fbbf24'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 0.5rem center;
        background-size: 1.25rem;
      }
      
      html:not(.dark) .settings-select {
        background: white;
        border: 1px solid rgba(148, 163, 184, 0.3);
        color: #1e293b;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%233b82f6'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
      }
      
      .settings-select:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }
      
      .settings-select option {
        background: #1e293b;
        color: white;
      }
      
      html:not(.dark) .settings-select option {
        background: white;
        color: #1e293b;
      }
      
      /* Buttons */
      .btn {
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        font-weight: 600;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.3s ease;
        border: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
      }
      
      .btn-primary {
        background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        color: white;
        box-shadow: 0 4px 16px rgba(59, 130, 246, 0.3);
      }
      
      .btn-primary:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
      }
      
      .btn-primary:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      
      .btn-secondary {
        background: rgba(100, 116, 139, 0.3);
        color: white;
        border: 1px solid rgba(148, 163, 184, 0.2);
      }
      
      .btn-secondary:hover {
        background: rgba(100, 116, 139, 0.5);
        border-color: rgba(148, 163, 184, 0.3);
      }
      
      .btn-danger {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: white;
        box-shadow: 0 4px 16px rgba(239, 68, 68, 0.3);
      }
      
      .btn-danger:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
      }
      
      .btn-group {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
      }
      
      /* Quick Links Grid */
      .quick-links {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
      }
      
      .quick-link {
        background: rgba(15, 23, 42, 0.6);
        border: 1px solid rgba(148, 163, 184, 0.1);
        border-radius: 0.75rem;
        padding: 1rem;
        text-align: center;
        text-decoration: none;
        transition: all 0.3s ease;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
      }
      
      .quick-link:hover {
        background: rgba(59, 130, 246, 0.1);
        border-color: rgba(59, 130, 246, 0.3);
        transform: translateY(-2px);
      }
      
      .quick-link i {
        font-size: 1.5rem;
        color: #fbbf24;
      }
      
      .quick-link span {
        color: white;
        font-size: 0.875rem;
        font-weight: 600;
        transition: color 0.3s ease;
      }
      
      html:not(.dark) .quick-link {
        background: white;
        border: 1px solid rgba(148, 163, 184, 0.2);
      }
      
      html:not(.dark) .quick-link span {
        color: #1e293b;
      }
      
      /* Loading State */
      .loading-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 60vh;
        gap: 1rem;
      }
      
      .loading-container p {
        color: rgba(148, 163, 184, 0.8);
        transition: color 0.3s ease;
      }
      
      html:not(.dark) .loading-container p {
        color: rgba(51, 65, 85, 0.7);
      }
      
      .spinner {
        width: 50px;
        height: 50px;
        border: 4px solid rgba(148, 163, 184, 0.2);
        border-top-color: #fbbf24;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      
      @keyframes spin {
        to { transform: rotate(360deg); }
      }
      
      /* Toast Notification */
      .toast {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 0.75rem;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        display: flex;
        align-items: center;
        gap: 0.75rem;
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.3s ease;
        z-index: 10000;
        max-width: 400px;
      }
      
      .toast.show {
        opacity: 1;
        transform: translateY(0);
      }
      
      .toast.error {
        background: linear-gradient(135deg, #ef4444, #dc2626);
      }
      
      /* Guest Prompt */
      .guest-prompt {
        background: rgba(30, 41, 59, 0.6);
        backdrop-filter: blur(16px);
        border: 1px solid rgba(148, 163, 184, 0.1);
        border-radius: 1rem;
        padding: 3rem 2rem;
        text-align: center;
        max-width: 500px;
        margin: 4rem auto;
        transition: all 0.3s ease;
      }
      
      html:not(.dark) .guest-prompt {
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid rgba(148, 163, 184, 0.2);
      }
      
      .guest-prompt i {
        font-size: 4rem;
        color: #fbbf24;
        margin-bottom: 1.5rem;
      }
      
      .guest-prompt h2 {
        font-size: 1.75rem;
        font-weight: 700;
        color: white;
        margin-bottom: 1rem;
        transition: color 0.3s ease;
      }
      
      html:not(.dark) .guest-prompt h2 {
        color: #1e293b;
      }
      
      .guest-prompt p {
        color: rgba(148, 163, 184, 0.8);
        margin-bottom: 2rem;
        transition: color 0.3s ease;
      }
      
      html:not(.dark) .guest-prompt p {
        color: rgba(51, 65, 85, 0.7);
      }
      
      /* Responsive */
      @media (max-width: 768px) {
        .settings-hero {
          margin-top: 60px;
        }
        
        .setting-row {
          flex-direction: column;
          align-items: flex-start;
          gap: 1rem;
        }
        
        .toggle-switch {
          align-self: flex-end;
        }
        
        .settings-select {
          width: 100%;
        }
        
        .btn-group {
          flex-direction: column;
        }
        
        .btn {
          width: 100%;
          justify-content: center;
        }
        
        .toast {
          left: 1rem;
          right: 1rem;
          bottom: 1rem;
        }
      }
      
      .hidden {
        display: none !important;
      }
    </style>
  </head>
  <body>
    <!-- Navigation -->
    <div id="navigation-placeholder"></div>
    
    <!-- Hero Section -->
    <div class="settings-hero">
      <h1>Settings</h1>
      <div class="user-badge" id="user-badge">
        <i class="fas fa-circle-notch fa-spin"></i>
        <span>Loading...</span>
      </div>
    </div>
    
    <!-- Content -->
    <div class="settings-content">
      <!-- Loading State -->
      <div id="loading-state" class="loading-container">
        <div class="spinner"></div>
        <p style="color: rgba(148, 163, 184, 0.8);">Loading your settings...</p>
      </div>
      
      <!-- Guest State -->
      <div id="guest-state" class="hidden">
        <div class="guest-prompt">
          <i class="fas fa-user-lock"></i>
          <h2>Sign In Required</h2>
          <p>Please sign in to access your personalized settings and preferences.</p>
          <button class="btn btn-primary" onclick="window.location.href='login.html'">
            <i class="fas fa-sign-in-alt"></i>
            Sign In
          </button>
        </div>
      </div>
      
      <!-- User Settings -->
      <div id="user-settings" class="hidden">
        <!-- Notifications -->
        <div class="settings-card">
          <div class="card-header">
            <div class="card-icon">
              <i class="fas fa-bell"></i>
            </div>
            <h2 class="card-title">Notifications</h2>
          </div>
          
          <div class="setting-row">
            <div class="setting-info">
              <div class="setting-label">Race Updates</div>
              <div class="setting-description">Get notified about upcoming races and results</div>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="notif-race" checked>
              <span class="toggle-slider"></span>
            </label>
          </div>
          
          <div class="setting-row">
            <div class="setting-info">
              <div class="setting-label">Team Newsletter</div>
              <div class="setting-description">Receive weekly updates and highlights</div>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="notif-newsletter" checked>
              <span class="toggle-slider"></span>
            </label>
          </div>
          
          <div class="setting-row">
            <div class="setting-info">
              <div class="setting-label">Social Media Updates</div>
              <div class="setting-description">Notifications for new posts and media</div>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="notif-social">
              <span class="toggle-slider"></span>
            </label>
          </div>
          
          <div class="setting-row" id="admin-notif-row" style="display: none;">
            <div class="setting-info">
              <div class="setting-label">Admin Alerts</div>
              <div class="setting-description">Notifications for pending approvals and actions</div>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="notif-admin" checked>
              <span class="toggle-slider"></span>
            </label>
          </div>
        </div>
        
        <!-- Display Preferences -->
        <div class="settings-card">
          <div class="card-header">
            <div class="card-icon">
              <i class="fas fa-palette"></i>
            </div>
            <h2 class="card-title">Display Preferences</h2>
          </div>
          
          <div class="setting-row">
            <div class="setting-info">
              <div class="setting-label">Theme</div>
              <div class="setting-description">Choose your preferred color scheme</div>
            </div>
            <select class="settings-select" id="theme-select">
              <option value="auto">Auto (System)</option>
              <option value="light">Light Mode</option>
              <option value="dark">Dark Mode</option>
            </select>
          </div>
          
          <div class="setting-row">
            <div class="setting-info">
              <div class="setting-label">Autoplay Videos</div>
              <div class="setting-description">Automatically play videos in gallery</div>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="autoplay-videos">
              <span class="toggle-slider"></span>
            </label>
          </div>
          
          <div class="setting-row">
            <div class="setting-info">
              <div class="setting-label">Reduce Animations</div>
              <div class="setting-description">Minimize motion for better performance</div>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="reduce-motion">
              <span class="toggle-slider"></span>
            </label>
          </div>
        </div>
        
        <!-- Favorite Driver -->
        <div class="settings-card">
          <div class="card-header">
            <div class="card-icon">
              <i class="fas fa-star"></i>
            </div>
            <h2 class="card-title">Favorite Driver</h2>
          </div>
          
          <div class="setting-row">
            <div class="setting-info">
              <div class="setting-label">Select Your Favorite</div>
              <div class="setting-description">Prioritize content from your favorite driver</div>
            </div>
            <select class="settings-select" id="favorite-driver">
              <option value="">None Selected</option>
              <option value="jon">Jon Kirsch #8</option>
              <option value="jonny">Jonny Kirsch #88</option>
            </select>
          </div>
        </div>
        
        <!-- Quick Links (Team/Admin Only) -->
        <div class="settings-card" id="quick-links-card" style="display: none;">
          <div class="card-header">
            <div class="card-icon">
              <i class="fas fa-link"></i>
            </div>
            <h2 class="card-title">Quick Links</h2>
          </div>
          
          <div class="quick-links">
            <a href="admin-console.html" class="quick-link">
              <i class="fas fa-tachometer-alt"></i>
              <span>Admin Console</span>
            </a>
            <a href="gallery.html" class="quick-link">
              <i class="fas fa-images"></i>
              <span>Gallery</span>
            </a>
            <a href="schedule.html" class="quick-link">
              <i class="fas fa-calendar"></i>
              <span>Schedule</span>
            </a>
            <a href="qna.html" class="quick-link">
              <i class="fas fa-question-circle"></i>
              <span>Q&A</span>
            </a>
          </div>
        </div>
        
        <!-- Account Actions -->
        <div class="settings-card">
          <div class="card-header">
            <div class="card-icon">
              <i class="fas fa-user"></i>
            </div>
            <h2 class="card-title">Account</h2>
          </div>
          
          <div class="btn-group">
            <button class="btn btn-primary" id="save-btn" onclick="saveSettings()">
              <i class="fas fa-save"></i>
              <span>Save Settings</span>
            </button>
            <button class="btn btn-secondary" onclick="resetSettings()">
              <i class="fas fa-undo"></i>
              <span>Reset to Default</span>
            </button>
            <button class="btn btn-danger" onclick="logout()">
              <i class="fas fa-sign-out-alt"></i>
              <span>Sign Out</span>
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Toast Notification -->
    <div id="toast" class="toast">
      <i class="fas fa-check-circle" id="toast-icon"></i>
      <span id="toast-message">Settings saved successfully!</span>
    </div>
    
    <!-- Scripts -->
    <script type="module" src="navigation.js"></script>
    <script src="assets/js/mobile-menu-tabs.js"></script>
    
    <script type="module">
      import { initializeApp, getApps, getApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
      import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
      import { getFirestore, doc, getDoc, setDoc } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';
      
      // Wait a moment for navigation.js to initialize Firebase
      await new Promise(resolve => setTimeout(resolve, 100));
      
      // Get or initialize Firebase
      let app;
      try {
        app = getApp();
      } catch (e) {
        // If no app exists, create one
        const firebaseConfig = {
          apiKey: "AIzaSyAWwholQM5RJC_LQcymKc6bM8c5hN4YKlw",
          authDomain: "redsracing-a7f8b.firebaseapp.com",
          projectId: "redsracing-a7f8b",
          storageBucket: "redsracing-a7f8b.firebasestorage.app",
          messagingSenderId: "398769104682",
          appId: "1:398769104682:web:d1cbbc92c651e94da3a5fe",
          measurementId: "G-1TJL2WK20C"
        };
        app = initializeApp(firebaseConfig);
      }
      
      const auth = getAuth(app);
      const db = getFirestore(app);
      
      let currentUser = null;
      let userRole = 'fan';
      
      // Function to handle auth state
      async function handleAuthState(user) {
        console.log('[Settings] Auth state changed, user:', user ? user.email : 'none');
        
        const loadingState = document.getElementById('loading-state');
        const guestState = document.getElementById('guest-state');
        const userSettings = document.getElementById('user-settings');
        const userBadge = document.getElementById('user-badge');
        
        if (!user) {
          // Not signed in
          console.log('[Settings] No user, showing guest prompt');
          loadingState.classList.add('hidden');
          guestState.classList.remove('hidden');
          userBadge.innerHTML = '<i class="fas fa-user"></i><span>Guest</span>';
        } else {
          console.log('[Settings] User found:', user.email);
          currentUser = user;
          
          try {
            // Get user role from token claims
            const token = await user.getIdTokenResult();
            userRole = token.claims.role || 'fan';
            console.log('[Settings] User role from token:', userRole);
            
            // Get user data
            let userData = {};
            try {
              const userDoc = await getDoc(doc(db, 'users', user.uid));
              userData = userDoc.data() || {};
            } catch (e) {
              console.log('Could not fetch user document:', e);
            }
            
            // Update badge
            const roleLabels = {
              'admin': 'Admin',
              'team-member': 'Team Member',
              'fan': 'Fan'
            };
            const roleIcons = {
              'admin': 'fa-crown',
              'team-member': 'fa-user-tie',
              'fan': 'fa-user'
            };
            
            userBadge.innerHTML = `<i class="fas ${roleIcons[userRole] || 'fa-user'}"></i><span>${roleLabels[userRole] || 'Fan'}</span>`;
            console.log('[Settings] Updated badge for role:', userRole);
            
            // Show team features for team members and admins
            if (userRole === 'admin' || userRole === 'team-member') {
              console.log('[Settings] Showing admin features');
              document.getElementById('admin-notif-row').style.display = 'flex';
              document.getElementById('quick-links-card').style.display = 'block';
            }
            
            // Load settings
            loadSettings(userData);
            
            console.log('[Settings] Showing user settings');
            loadingState.classList.add('hidden');
            userSettings.classList.remove('hidden');
          } catch (error) {
            console.error('[Settings] Error loading user data:', error);
            loadingState.classList.add('hidden');
            userSettings.classList.remove('hidden');
            loadSettings({});
          }
        }
      }
      
      // Check current user immediately
      const currentAuthUser = auth.currentUser;
      console.log('[Settings] Current user on load:', currentAuthUser ? currentAuthUser.email : 'none');
      
      if (currentAuthUser) {
        // User already signed in, handle immediately
        handleAuthState(currentAuthUser);
      }
      
      // Also listen for auth state changes
      onAuthStateChanged(auth, handleAuthState);
      
      // Load settings from Firestore and localStorage
      function loadSettings(userData) {
        const localSettings = JSON.parse(localStorage.getItem('rr_settings') || '{}');
        const settings = { ...localSettings, ...(userData?.settings || {}) };
        
        // Apply settings to UI
        document.getElementById('notif-race').checked = settings.notifRace !== false;
        document.getElementById('notif-newsletter').checked = settings.notifNewsletter !== false;
        document.getElementById('notif-social').checked = settings.notifSocial || false;
        document.getElementById('notif-admin').checked = settings.notifAdmin !== false;
        
        document.getElementById('theme-select').value = settings.theme || 'auto';
        document.getElementById('autoplay-videos').checked = settings.autoplayVideos || false;
        document.getElementById('reduce-motion').checked = settings.reduceMotion || false;
        
        document.getElementById('favorite-driver').value = settings.favoriteDriver || '';
        
        // Apply theme
        applyTheme(settings.theme || 'auto');
        
        // Apply reduce motion
        if (settings.reduceMotion) {
          document.documentElement.style.setProperty('--animation-duration', '0.01ms');
        }
      }
      
      // Apply theme
      function applyTheme(theme) {
        const html = document.documentElement;
        
        if (theme === 'dark') {
          html.classList.add('dark');
        } else if (theme === 'light') {
          html.classList.remove('dark');
        } else {
          // Auto - use system preference
          if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
            html.classList.add('dark');
          } else {
            html.classList.remove('dark');
          }
        }
      }
      
      // Save settings
      window.saveSettings = async function() {
        const saveBtn = document.getElementById('save-btn');
        const originalHTML = saveBtn.innerHTML;
        
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>Saving...</span>';
        
        const settings = {
          notifRace: document.getElementById('notif-race').checked,
          notifNewsletter: document.getElementById('notif-newsletter').checked,
          notifSocial: document.getElementById('notif-social').checked,
          notifAdmin: document.getElementById('notif-admin').checked,
          theme: document.getElementById('theme-select').value,
          autoplayVideos: document.getElementById('autoplay-videos').checked,
          reduceMotion: document.getElementById('reduce-motion').checked,
          favoriteDriver: document.getElementById('favorite-driver').value,
          updatedAt: new Date().toISOString()
        };
        
        try {
          // Save to localStorage
          localStorage.setItem('rr_settings', JSON.stringify(settings));
          
          // Save to Firestore if logged in
          if (currentUser) {
            try {
              await setDoc(doc(db, 'users', currentUser.uid), {
                settings: settings,
                updatedAt: new Date()
              }, { merge: true });
            } catch (e) {
              console.log('Could not save to Firestore:', e);
              // Continue anyway - localStorage is saved
            }
          }
          
          // Apply theme
          applyTheme(settings.theme);
          
          // Apply reduce motion
          if (settings.reduceMotion) {
            document.documentElement.style.setProperty('--animation-duration', '0.01ms');
          } else {
            document.documentElement.style.removeProperty('--animation-duration');
          }
          
          showToast('Settings saved successfully!', 'success');
        } catch (error) {
          console.error('Error saving settings:', error);
          showToast('Failed to save settings', 'error');
        } finally {
          saveBtn.disabled = false;
          saveBtn.innerHTML = originalHTML;
        }
      };
      
      // Reset settings
      window.resetSettings = function() {
        if (!confirm('Are you sure you want to reset all settings to default?')) {
          return;
        }
        
        // Clear local storage
        localStorage.removeItem('rr_settings');
        
        // Reset UI to defaults
        document.getElementById('notif-race').checked = true;
        document.getElementById('notif-newsletter').checked = true;
        document.getElementById('notif-social').checked = false;
        document.getElementById('notif-admin').checked = true;
        document.getElementById('theme-select').value = 'auto';
        document.getElementById('autoplay-videos').checked = false;
        document.getElementById('reduce-motion').checked = false;
        document.getElementById('favorite-driver').value = '';
        
        applyTheme('auto');
        document.documentElement.style.removeProperty('--animation-duration');
        
        showToast('Settings reset to default', 'success');
      };
      
      // Logout
      window.logout = async function() {
        if (!confirm('Are you sure you want to sign out?')) {
          return;
        }
        
        try {
          await signOut(auth);
          window.location.href = 'index.html';
        } catch (error) {
          console.error('Logout error:', error);
          showToast('Error signing out', 'error');
        }
      };
      
      // Toast notification
      function showToast(message, type = 'success') {
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toast-message');
        const toastIcon = document.getElementById('toast-icon');
        
        toastMessage.textContent = message;
        
        if (type === 'error') {
          toast.classList.add('error');
          toastIcon.className = 'fas fa-exclamation-circle';
        } else {
          toast.classList.remove('error');
          toastIcon.className = 'fas fa-check-circle';
        }
        
        toast.classList.add('show');
        
        setTimeout(() => {
          toast.classList.remove('show');
        }, 3000);
      }
      
      // Listen to theme changes
      document.getElementById('theme-select').addEventListener('change', (e) => {
        applyTheme(e.target.value);
      });
      
      // Listen to reduce motion changes
      document.getElementById('reduce-motion').addEventListener('change', (e) => {
        if (e.target.checked) {
          document.documentElement.style.setProperty('--animation-duration', '0.01ms');
        } else {
          document.documentElement.style.removeProperty('--animation-duration');
        }
      });
    </script>
  </body>
</html>
