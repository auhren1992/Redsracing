<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - RedsRacing #8</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Racing+Sans+One&family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles/main.css">
</head>
<body class="bg-dark-blue">
    <!-- Header will be added later if needed, focus on core functionality first -->
    <main class="pt-20">
        <section id="admin-panel" class="py-16">
            <div class="container mx-auto px-6">
                <div id="loading-state" class="text-center">
                    <p class="text-lg text-slate-400">Verifying access...</p>
                </div>

                <div id="admin-content" style="display: none;">
                    <h1 class="font-racing text-5xl uppercase mb-12 text-center">Admin Control <span class="neon-yellow">Panel</span></h1>

                    <div class="space-y-12">
                        <div id="announcements-section" class="form-container p-8 rounded-lg">
                            <h2 class="font-racing text-3xl uppercase mb-6 text-white">Post an Announcement</h2>
                            <form id="announcement-form">
                                <div class="space-y-4">
                                    <div>
                                        <label for="announcement-title" class="block text-sm font-medium text-slate-300 mb-1">Title</label>
                                        <input type="text" id="announcement-title" required class="form-input w-full rounded-md">
                                    </div>
                                    <div>
                                        <label for="announcement-content" class="block text-sm font-medium text-slate-300 mb-1">Content</label>
                                        <textarea id="announcement-content" rows="4" required class="form-input w-full rounded-md"></textarea>
                                    </div>
                                </div>
                                <div class="mt-6">
                                    <button type="submit" id="announcement-submit-btn" class="bg-neon-yellow text-slate-900 font-bold py-2 px-6 rounded-md hover:bg-yellow-300 transition disabled:opacity-50">Post Announcement</button>
                                </div>
                                <p id="announcement-status" class="text-sm mt-4 h-4"></p>
                            </form>
                        </div>

                        <div id="races-section" class="form-container p-8 rounded-lg space-y-8">
                            <div>
                                <h3 class="font-racing text-2xl uppercase mb-4 text-white">Create New Race</h3>
                                <form id="create-race-form" class="space-y-4">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label for="race-trackName" class="block text-sm font-medium text-slate-300">Track Name</label>
                                            <input type="text" id="race-trackName" required class="form-input mt-1 block w-full rounded-md">
                                        </div>
                                        <div>
                                            <label for="race-series" class="block text-sm font-medium text-slate-300">Series</label>
                                            <input type="text" id="race-series" required class="form-input mt-1 block w-full rounded-md">
                                        </div>
                                        <div>
                                            <label for="race-date" class="block text-sm font-medium text-slate-300">Race Date</label>
                                            <input type="datetime-local" id="race-date" required class="form-input mt-1 block w-full rounded-md">
                                        </div>
                                        <div>
                                            <label for="race-laps" class="block text-sm font-medium text-slate-300">Laps</label>
                                            <input type="number" id="race-laps" required class="form-input mt-1 block w-full rounded-md">
                                        </div>
                                    </div>
                                    <div>
                                        <button type="submit" id="create-race-btn" class="bg-blue-600 text-white font-bold py-2 px-5 rounded-md hover:bg-blue-500 transition disabled:opacity-50">Create Race</button>
                                    </div>
                                    <p id="create-race-status" class="text-sm h-4"></p>
                                </form>
                            </div>
                            <div class="border-t border-slate-700"></div>
                            <div>
                                <h3 class="font-racing text-2xl uppercase mb-4 text-white">Existing Races</h3>
                                <div id="existing-races-container" class="space-y-4">
                                    <!-- Races will be dynamically loaded here -->
                                    <p class="text-slate-400">Loading races...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="permission-denied" class="text-center" style="display: none;">
                    <h2 class="font-racing text-4xl text-red-500">Access Denied</h2>
                    <p class="text-slate-400 mt-4">You do not have permission to view this page.</p>
                    <a href="index.html" class="mt-6 inline-block bg-neon-yellow text-slate-900 font-bold py-2 px-6 rounded-md hover:bg-yellow-300 transition">Go to Homepage</a>
                </div>
            </div>
        </section>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-functions.js";
        import { getFirestore, collection, query, orderBy, onSnapshot, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyARFiFCadGKFUc_s6x3qNX8F4jsVawkzVg",
          authDomain: "redsracing-a7f8b.firebaseapp.com",
          projectId: "redsracing-a7f8b",
          storageBucket: "redsracing-a7f8b.firebasestorage.app",
          messagingSenderId: "517034606151",
          appId: "1:517034606151:web:24cae262e1d98832757b62"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        const loadingState = document.getElementById('loading-state');
        const adminContent = document.getElementById('admin-content');
        const permissionDenied = document.getElementById('permission-denied');

        onAuthStateChanged(auth, user => {
            if (user) {
                // User is signed in, check their role.
                user.getIdTokenResult().then(idTokenResult => {
                    loadingState.style.display = 'none';
                    if (idTokenResult.claims.role === 'admin') {
                        // User is an admin, show the content.
                        adminContent.style.display = 'block';

                        // --- Initialize Functions and Set Up Admin Logic ---
                        const functions = getFunctions(app, 'us-central1');

                        // Callable functions
                        const createAnnouncement = httpsCallable(functions, 'create_announcement');

                        // Announcement Form Logic
                        const announcementForm = document.getElementById('announcement-form');
                        const announcementSubmitBtn = document.getElementById('announcement-submit-btn');
                        const announcementStatus = document.getElementById('announcement-status');

                        announcementForm.addEventListener('submit', async (e) => {
                            e.preventDefault();
                            announcementSubmitBtn.disabled = true;
                            announcementStatus.textContent = 'Posting...';
                            announcementStatus.style.color = '#e2e8f0'; // Default text color

                            const title = document.getElementById('announcement-title').value;
                            const content = document.getElementById('announcement-content').value;

                            try {
                                const result = await createAnnouncement({ title, content });
                                if (result.data.status === 'success') {
                                    announcementStatus.textContent = 'Announcement posted successfully!';
                                    announcementStatus.style.color = '#22c55e'; // Green for success
                                    announcementForm.reset();
                                } else {
                                    throw new Error(result.data.message || 'An unknown error occurred.');
                                }
                            } catch (error) {
                                console.error('Error posting announcement:', error);
                                announcementStatus.textContent = `Error: ${error.message}`;
                                announcementStatus.style.color = '#ef4444'; // Red for error
                            } finally {
                                announcementSubmitBtn.disabled = false;
                            }
                        });

                        // --- Race Management Logic ---
                        const db = getFirestore(app);
                        const createRace = httpsCallable(functions, 'create_race');
                        const postResults = httpsCallable(functions, 'post_results');

                        const createRaceForm = document.getElementById('create-race-form');
                        const createRaceBtn = document.getElementById('create-race-btn');
                        const createRaceStatus = document.getElementById('create-race-status');
                        const existingRacesContainer = document.getElementById('existing-races-container');

                        // Results Modal Elements
                        const resultsModal = document.getElementById('results-modal');
                        const modalRaceName = document.getElementById('modal-race-name');
                        const resultsForm = document.getElementById('results-form');
                        const resultsJsonTextarea = document.getElementById('results-json');
                        const modalCancelBtn = document.getElementById('modal-cancel-btn');
                        const modalSubmitBtn = document.getElementById('modal-submit-btn');
                        const postResultsStatus = document.getElementById('post-results-status');
                        let currentRaceIdForModal = null;

                        // Render existing races
                        const renderRaces = (races) => {
                            existingRacesContainer.innerHTML = '';
                            if (races.length === 0) {
                                existingRacesContainer.innerHTML = '<p class="text-slate-400">No races created yet.</p>';
                                return;
                            }
                            races.forEach(race => {
                                const raceEl = document.createElement('div');
                                raceEl.className = 'p-4 bg-slate-800/50 rounded-lg flex justify-between items-center';
                                const raceDate = race.raceDate.toDate(); // Convert Firestore Timestamp to JS Date
                                const dateString = raceDate.toLocaleString();

                                let statusHTML = race.isComplete
                                    ? `<span class="text-xs font-bold text-green-400 bg-green-900/50 px-2 py-1 rounded-full">Complete</span>`
                                    : `<span class="text-xs font-bold text-yellow-400 bg-yellow-900/50 px-2 py-1 rounded-full">Upcoming</span>`;

                                raceEl.innerHTML = `
                                    <div>
                                        <p class="font-bold text-white">${race.trackName}</p>
                                        <p class="text-sm text-slate-400">${race.series} - ${dateString}</p>
                                    </div>
                                    <div class="flex items-center gap-4">
                                        ${statusHTML}
                                        ${!race.isComplete ? `<button data-race-id="${race.id}" data-race-name="${race.trackName}" class="post-results-btn bg-green-600 text-white font-bold py-1 px-3 rounded-md text-sm hover:bg-green-500">Post Results</button>` : ''}
                                    </div>
                                `;
                                existingRacesContainer.appendChild(raceEl);
                            });
                        };

                        // Listen for race data from Firestore
                        const racesQuery = query(collection(db, "races"), orderBy("raceDate", "desc"));
                        onSnapshot(racesQuery, (snapshot) => {
                            const races = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            renderRaces(races);
                        });

                        // Handle Create Race form submission
                        createRaceForm.addEventListener('submit', async (e) => {
                            e.preventDefault();
                            createRaceBtn.disabled = true;
                            createRaceStatus.textContent = 'Creating race...';
                            createRaceStatus.style.color = '#e2e8f0';

                            const payload = {
                                trackName: document.getElementById('race-trackName').value,
                                series: document.getElementById('race-series').value,
                                raceDate: document.getElementById('race-date').value,
                                laps: parseInt(document.getElementById('race-laps').value, 10)
                            };

                            try {
                                const result = await createRace(payload);
                                if (result.data.status === 'success') {
                                    createRaceStatus.textContent = 'Race created successfully!';
                                    createRaceStatus.style.color = '#22c55e';
                                    createRaceForm.reset();
                                } else {
                                    throw new Error(result.data.message || 'Unknown error.');
                                }
                            } catch (error) {
                                console.error('Error creating race:', error);
                                createRaceStatus.textContent = `Error: ${error.message}`;
                                createRaceStatus.style.color = '#ef4444';
                            } finally {
                                createRaceBtn.disabled = false;
                                setTimeout(() => { createRaceStatus.textContent = ''; }, 5000);
                            }
                        });

                        // Handle Results Modal
                        existingRacesContainer.addEventListener('click', (e) => {
                            if (e.target.classList.contains('post-results-btn')) {
                                currentRaceIdForModal = e.target.dataset.raceId;
                                modalRaceName.textContent = e.target.dataset.raceName;
                                resultsModal.style.display = 'flex';
                            }
                        });

                        modalCancelBtn.addEventListener('click', () => {
                            resultsModal.style.display = 'none';
                            resultsForm.reset();
                            postResultsStatus.textContent = '';
                            currentRaceIdForModal = null;
                        });

                        resultsForm.addEventListener('submit', async (e) => {
                            e.preventDefault();
                            modalSubmitBtn.disabled = true;
                            postResultsStatus.textContent = 'Submitting...';
                            postResultsStatus.style.color = '#e2e8f0';

                            let resultsList;
                            try {
                                resultsList = JSON.parse(resultsJsonTextarea.value);
                                if (!Array.isArray(resultsList)) {
                                    throw new Error('Input must be a JSON array.');
                                }
                            } catch (error) {
                                postResultsStatus.textContent = `Invalid JSON: ${error.message}`;
                                postResultsStatus.style.color = '#ef4444';
                                modalSubmitBtn.disabled = false;
                                return;
                            }

                            try {
                                const result = await postResults({ raceId: currentRaceIdForModal, results: resultsList });
                                if (result.data.status === 'success') {
                                    postResultsStatus.textContent = 'Results posted successfully!';
                                    postResultsStatus.style.color = '#22c55e';
                                    setTimeout(() => {
                                        modalCancelBtn.click();
                                    }, 2000);
                                } else {
                                    throw new Error(result.data.message || 'Unknown error.');
                                }
                            } catch (error) {
                                console.error('Error posting results:', error);
                                postResultsStatus.textContent = `Error: ${error.message}`;
                                postResultsStatus.style.color = '#ef4444';
                            } finally {
                                modalSubmitBtn.disabled = false;
                            }
                        });

                    } else {
                        // User is not an admin, show permission denied.
                        permissionDenied.style.display = 'block';
                    }
                });
            } else {
                // No user is signed in, redirect to login.
                window.location.href = 'login.html';
            }
        });
    </script>

    <!-- Results Modal -->
    <div id="results-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50" style="display: none;">
        <div class="bg-slate-900 border border-slate-700 rounded-lg max-w-2xl w-full p-8 space-y-4">
            <h3 class="font-racing text-2xl uppercase text-white">Post Results for <span id="modal-race-name" class="text-neon-yellow"></span></h3>
            <form id="results-form">
                <div>
                    <label for="results-json" class="block text-sm font-medium text-slate-300 mb-1">Results JSON</label>
                    <p class="text-xs text-slate-400 mb-2">Paste the results as a JSON array. Each object must have: `driverUid`, `driverName`, `finishPosition`, `pointsEarned`.</p>
                    <textarea id="results-json" rows="10" required class="form-input w-full rounded-md font-mono text-sm" placeholder='[{"driverUid": "...", "driverName": "...", "finishPosition": 1, "pointsEarned": 50}]'></textarea>
                </div>
                <div class="flex justify-end items-center gap-4 mt-6">
                    <p id="post-results-status" class="text-sm h-4 flex-grow"></p>
                    <button type="button" id="modal-cancel-btn" class="text-slate-400 hover:text-white transition">Cancel</button>
                    <button type="submit" id="modal-submit-btn" class="bg-green-600 text-white font-bold py-2 px-5 rounded-md hover:bg-green-500 transition disabled:opacity-50">Submit Results</button>
                </div>
            </form>
        </div>
    </div>
</body>
</html>
